<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SatAlign Pro Enterprise - Professional Satellite Dish Alignment</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Meta tags for SEO and PWA -->
    <meta name="description" content="Professional satellite dish alignment application with AR guidance for iOS and Android devices">
    <meta name="keywords" content="satellite, dish, alignment, professional, enterprise, GPS, compass, AR, iOS, Android">
    <meta name="author" content="SatAlign Pro Enterprise">
    <meta name="theme-color" content="#0066cc">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SatAlign Pro">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self' blob:; connect-src 'self' https:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    
    <!-- Professional Icons -->
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3ccircle cx='50' cy='50' r='40' fill='%230066cc'/%3e%3ccircle cx='50' cy='50' r='30' fill='none' stroke='%23ffffff' stroke-width='2'/%3e%3ccircle cx='50' cy='30' r='3' fill='%23ffffff'/%3e%3c/svg%3e">
    
    <style>
        :root {
            --primary-color: #0066cc;
            --secondary-color: #004499;
            --accent-color: #0080ff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --dark-bg: #1a1a1a;
            --darker-bg: #0f0f0f;
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.8);
            --text-muted: rgba(255,255,255,0.6);
            --border-color: rgba(255,255,255,0.1);
            --glass-bg: rgba(26,26,26,0.9);
            --glass-border: rgba(255,255,255,0.15);
            --shadow-color: rgba(0,0,0,0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: var(--darker-bg);
            color: var(--text-primary);
            overflow: hidden;
            position: relative;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height for mobile */
            width: 100vw;
            font-weight: 400;
            letter-spacing: -0.01em;
            line-height: 1.5;
            /* Fixed: Remove user-select: none to allow proper touch interaction */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* Fixed: Improve touch handling */
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: pan-x pan-y; /* Allow panning but prevent zoom */
        }

        body.rtl {
            direction: rtl;
        }

        body.ltr {
            direction: ltr;
        }

        /* Fixed: Improve touch targets */
        button, select, input, .focusable {
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            min-height: 44px; /* iOS minimum touch target */
            min-width: 44px;
        }

        /* Video Background - Full Screen */
        #videoContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }

        #video {
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            object-fit: cover;
            filter: brightness(0.8) contrast(1.1);
            /* Fixed: No transform for back camera on iOS */
            -webkit-transform: none;
            transform: none;
        }

        /* Fixed: Improve video display on iOS */
        #video::-webkit-media-controls {
            display: none !important;
        }

        #video::-webkit-media-controls-enclosure {
            display: none !important;
        }

        /* AR Overlay for Sky Pointing */
        .ar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* Sky Compass - Shows direction when pointing up */
        .sky-compass {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 200px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 15;
            will-change: transform; /* Fixed: Improve performance */
        }

        .compass-ring {
            width: 100%;
            height: 100%;
            border: 3px solid var(--primary-color);
            border-radius: 50%;
            position: relative;
            background: rgba(0,102,204,0.1);
            box-shadow: 0 0 30px rgba(0,102,204,0.4);
        }

        .compass-needle {
            position: absolute;
            top: 20px;
            left: 50%;
            width: 4px;
            height: 80px;
            background: linear-gradient(180deg, var(--danger-color), var(--warning-color));
            transform: translateX(-50%);
            transform-origin: bottom center;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(220,53,69,0.6);
            transition: transform 0.2s ease; /* Fixed: Faster response */
            will-change: transform;
        }

        .compass-directions {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .direction-marker {
            position: absolute;
            width: 2px;
            height: 15px;
            background: var(--text-muted);
            left: 50%;
            top: 10px;
            transform-origin: 50% 90px;
        }

        .direction-marker.major {
            height: 25px;
            width: 3px;
            background: var(--text-primary);
        }

        .direction-marker.north {
            background: var(--danger-color);
            width: 4px;
            height: 30px;
        }

        .direction-label {
            position: absolute;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8); /* Fixed: Better visibility */
        }

        .direction-label.north {
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--danger-color);
            font-size: 16px;
        }

        .direction-label.east {
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
        }

        .direction-label.south {
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
        }

        .direction-label.west {
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Satellite Target Indicator */
        .satellite-target {
            position: absolute;
            width: 80px;
            height: 80px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 20;
            transition: all 0.2s ease; /* Fixed: Faster response */
            will-change: transform, left, top;
        }

        .target-ring {
            width: 100%;
            height: 100%;
            border: 4px solid var(--danger-color);
            border-radius: 50%;
            background: rgba(220,53,69,0.1);
            position: relative;
            animation: targetPulse 2s infinite ease-in-out;
            box-shadow: 0 0 30px rgba(220,53,69,0.5);
        }

        .target-ring.aligned {
            border-color: var(--success-color);
            background: rgba(40,167,69,0.1);
            box-shadow: 0 0 30px rgba(40,167,69,0.5);
        }

        .target-ring.close {
            border-color: var(--warning-color);
            background: rgba(255,193,7,0.1);
            box-shadow: 0 0 30px rgba(255,193,7,0.5);
        }

        .target-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 32px;
            height: 32px;
            transform: translate(-50%, -50%);
            fill: currentColor;
            color: var(--text-primary);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        .target-label {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        @keyframes targetPulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Elevation Indicator */
        .elevation-indicator {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 200px;
            z-index: 15;
        }

        .elevation-scale {
            width: 100%;
            height: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-radius: 30px;
            border: 2px solid var(--glass-border);
            position: relative;
            box-shadow: 0 8px 32px var(--shadow-color);
        }

        .elevation-pointer {
            position: absolute;
            left: 50%;
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
            transform: translateX(-50%);
            transition: top 0.2s ease; /* Fixed: Faster response */
            box-shadow: 0 0 10px rgba(0,102,204,0.6);
            will-change: top;
        }

        .elevation-labels {
            position: absolute;
            left: -30px;
            top: 0;
            height: 100%;
            width: 25px;
        }

        .elevation-label {
            position: absolute;
            font-size: 10px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* HUD Interface */
        .hud-interface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 25;
        }

        /* Top Control Panel */
        .control-panel {
            position: absolute;
            top: env(safe-area-inset-top, 20px);
            left: 16px;
            right: 16px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            pointer-events: all;
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px var(--shadow-color);
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            max-height: 65vh;
            overflow-y: auto;
            /* Fixed: Better scrolling on iOS */
            -webkit-overflow-scrolling: touch;
        }

        .control-panel.collapsed {
            transform: translateY(-85%);
            opacity: 0.8;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .app-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .app-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
        }

        .header-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .language-selector {
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 4px;
            display: flex;
            gap: 2px;
        }

        .lang-btn {
            padding: 8px 14px; /* Fixed: Larger touch targets */
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            font-weight: 500;
            min-width: 44px; /* Fixed: iOS minimum touch target */
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Fixed: Improve touch handling */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .lang-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(0,102,204,0.3);
        }

        /* Fixed: Improve button touch feedback */
        .lang-btn:active {
            transform: scale(0.95);
        }

        .control-btn {
            width: 44px; /* Fixed: Larger touch target */
            height: 44px;
            border: none;
            border-radius: 8px;
            background: var(--dark-bg);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            border: 1px solid var(--border-color);
            /* Fixed: Improve touch handling */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .control-btn:hover,
        .control-btn:focus {
            background: var(--primary-color);
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        /* Fixed: Touch feedback */
        .control-btn:active {
            transform: scale(0.95);
        }

        /* Device Orientation Guidance */
        .orientation-guide {
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(0,102,204,0.1), rgba(0,128,255,0.1));
            border-radius: 12px;
            border: 1px solid rgba(0,102,204,0.2);
        }

        .orientation-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .orientation-text {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Satellite Selection */
        .satellite-section {
            margin-bottom: 20px;
        }

        .section-label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .satellite-select {
            width: 100%;
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--dark-bg);
            color: var(--text-primary);
            font-size: 16px; /* Fixed: Prevent zoom on iOS */
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
            transition: all 0.2s ease;
            cursor: pointer;
            /* Fixed: Better touch handling */
            min-height: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .rtl .satellite-select {
            background-position: left 12px center;
            padding-left: 40px;
            padding-right: 16px;
        }

        .satellite-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0,102,204,0.1);
        }

        /* Metrics Grid */
        .metrics-section {
            margin-bottom: 20px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .metric-card {
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            padding: 16px 12px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            /* Fixed: Prevent accidental touch selection */
            user-select: none;
            -webkit-user-select: none;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .metric-card:hover::before {
            opacity: 1;
        }

        .metric-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
            line-height: 1;
        }

        .metric-unit {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 400;
        }

        /* Status Grid */
        .status-section {
            margin-bottom: 16px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .status-card {
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.2s ease;
            /* Fixed: Prevent accidental touch selection */
            user-select: none;
            -webkit-user-select: none;
        }

        .status-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-weight: 500;
        }

        .status-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 6px;
            background: var(--danger-color);
            animation: pulse 2s infinite;
        }

        .status-indicator.good {
            background: var(--success-color);
        }

        .status-indicator.warning {
            background: var(--warning-color);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Bottom Status Panel */
        .status-panel {
            position: absolute;
            bottom: env(safe-area-inset-bottom, 20px);
            left: 20px;
            right: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--glass-border);
            text-align: center;
            box-shadow: 0 8px 32px var(--shadow-color);
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            pointer-events: all;
        }

        .status-panel.collapsed {
            transform: translateY(80%);
            opacity: 0.8;
        }

        .alignment-status {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .alignment-details {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .precision-bar {
            width: 100%;
            height: 8px;
            background: var(--dark-bg);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            position: relative;
        }

        .precision-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--danger-color), var(--warning-color), var(--success-color));
            border-radius: 4px;
            transition: width 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); /* Fixed: Smoother animation */
            position: relative;
            overflow: hidden;
            will-change: width;
        }

        .precision-text {
            font-size: 12px;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
            font-weight: 500;
        }

        /* Toggle Button */
        .toggle-show-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 56px;
            height: 56px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            z-index: 30;
            transition: all 0.3s ease;
            display: none;
            pointer-events: all;
            box-shadow: 0 8px 32px rgba(0,102,204,0.4);
            /* Fixed: Better touch handling */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .toggle-show-btn.visible {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-show-btn:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 12px 40px rgba(0,102,204,0.5);
        }

        /* Fixed: Touch feedback */
        .toggle-show-btn:active {
            transform: translate(-50%, -50%) scale(0.95);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            height: 100dvh;
            background: linear-gradient(135deg, var(--darker-bg), var(--dark-bg));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-content {
            text-align: center;
            max-width: 400px;
            padding: 20px;
        }

        .loading-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            animation: loadingPulse 2s infinite ease-in-out;
        }

        @keyframes loadingPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .loading-details {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        /* Permission Steps */
        .permission-buttons {
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
            max-width: 400px;
            width: 100%;
        }

        .permission-step {
            text-align: center;
            width: 100%;
            padding: 20px;
            background: var(--glass-bg);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
        }

        .step-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            background: var(--primary-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .step-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .step-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 16px 32px; /* Fixed: Larger touch targets */
            border-radius: 12px;
            font-size: 16px; /* Fixed: Prevent zoom on iOS */
            font-weight: 600;
            cursor: pointer;
            min-width: 200px;
            min-height: 48px; /* Fixed: Minimum touch target */
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            /* Fixed: Better touch handling */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,102,204,0.3);
        }

        /* Fixed: Touch feedback */
        .btn:active {
            transform: translateY(0) scale(0.98);
        }

        .btn:disabled {
            background: var(--dark-bg);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.success {
            background: var(--success-color);
        }

        /* Fixed: iOS Safari bottom safe area */
        @supports (padding: max(0px)) {
            .status-panel {
                bottom: max(20px, env(safe-area-inset-bottom));
                padding-bottom: max(20px, calc(20px + env(safe-area-inset-bottom)));
            }
            
            .control-panel {
                top: max(20px, env(safe-area-inset-top));
                padding-top: max(20px, calc(20px + env(safe-area-inset-top)));
            }
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .control-panel {
                top: env(safe-area-inset-top, 10px);
                left: 10px;
                right: 10px;
                padding: 16px;
            }

            .sky-compass {
                width: 160px;
                height: 160px;
            }

            .satellite-target {
                width: 60px;
                height: 60px;
            }

            .status-panel {
                left: 10px;
                right: 10px;
                padding: 16px;
            }

            .elevation-indicator {
                right: 10px;
                width: 50px;
                height: 160px;
            }

            /* Fixed: Better touch targets on small screens */
            .lang-btn {
                min-width: 40px;
                padding: 6px 12px;
            }

            .control-btn {
                width: 40px;
                height: 40px;
            }
        }

        @media (max-width: 360px) {
            .metrics-grid {
                gap: 8px;
            }

            .metric-card {
                padding: 12px 8px;
            }

            .sky-compass {
                width: 140px;
                height: 140px;
            }
        }

        /* Fixed: Landscape orientation improvements */
        @media (orientation: landscape) {
            .control-panel {
                max-height: 50vh;
                max-height: 50dvh;
            }
            
            .status-panel {
                padding: 12px 20px;
            }
            
            .sky-compass {
                width: 140px;
                height: 140px;
            }

            .satellite-target {
                width: 60px;
                height: 60px;
            }
        }

        /* Fixed: Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus styles for accessibility */
        .focusable:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Fixed: Better focus for touch devices */
        .focusable:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Fixed: Hide focus outline for touch interactions */
        .focusable:focus:not(:focus-visible) {
            outline: none;
        }

        /* Fixed: Improve error dialog on mobile */
        .error-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 1px solid var(--danger-color);
            box-shadow: 0 20px 60px rgba(220,53,69,0.3);
            z-index: 2000;
            animation: errorSlideIn 0.3s ease-out;
        }

        @keyframes errorSlideIn {
            from { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1); 
            }
        }

        .error-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            background: var(--danger-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
        }

        .error-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--danger-color);
        }

        .error-message {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .error-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--dark-bg);
            border-color: var(--primary-color);
        }

        /* Fixed: iOS specific fixes */
        @supports (-webkit-appearance: none) {
            /* iOS Safari specific styles */
            body {
                -webkit-text-size-adjust: 100%;
                -webkit-font-smoothing: antialiased;
            }

            .satellite-select {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }

            /* Fixed: Prevent iOS zoom on form inputs */
            input, select, textarea {
                font-size: 16px !important;
            }

            /* Fixed: iOS specific video handling */
            #video {
                -webkit-transform: none !important;
                transform: none !important;
            }
        }

        /* Fixed: Better print styles */
        @media print {
            .control-panel,
            .status-panel,
            .sky-compass,
            .satellite-target,
            .elevation-indicator,
            .loading-screen {
                display: none;
            }
            
            body::after {
                content: "SatAlign Pro Enterprise - Professional Satellite Alignment Application";
                position: fixed;
                bottom: 20px;
                left: 20px;
                font-size: 12px;
                color: #666;
            }
        }
    </style>
</head>
<body class="ltr">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">üõ∞Ô∏è</div>
            <div class="loading-text" data-key="loading.title">Initializing System</div>
            <div id="loadingDetails" class="loading-details" data-key="loading.details">Starting up...</div>
            <div class="loading-spinner"></div>
            
            <div id="permissionButtons" class="permission-buttons" style="display: none;">
                <div class="permission-step">
                    <div class="step-icon">üì∑</div>
                    <div class="step-title" data-key="permissions.camera.title">Camera Access Required</div>
                    <div class="step-description" data-key="permissions.camera.description">We need camera access to show the sky view for satellite alignment</div>
                    <button class="btn focusable" id="cameraBtn" onclick="requestCameraPermission()">
                        <span data-key="permissions.camera.button">Grant Camera Access</span>
                    </button>
                </div>

                <div class="permission-step">
                    <div class="step-icon">üìç</div>
                    <div class="step-title" data-key="permissions.location.title">Location Access Required</div>
                    <div class="step-description" data-key="permissions.location.description">We need your location to calculate accurate satellite positions</div>
                    <button class="btn focusable" id="locationBtn" onclick="requestLocationPermission()" disabled>
                        <span data-key="permissions.location.button">Grant Location Access</span>
                    </button>
                </div>

                <div class="permission-step">
                    <div class="step-icon">üß≠</div>
                    <div class="step-title" data-key="permissions.sensors.title">Device Sensors Required</div>
                    <div class="step-description" data-key="permissions.sensors.description">We need compass and orientation sensors for accurate positioning</div>
                    <button class="btn focusable" id="orientationBtn" onclick="requestOrientationPermission()" disabled>
                        <span data-key="permissions.sensors.button">Grant Sensor Access</span>
                    </button>
                </div>

                <div class="permission-step" id="startStep" style="display: none;">
                    <div class="step-icon">‚úÖ</div>
                    <div class="step-title" data-key="permissions.complete.title">All Permissions Granted</div>
                    <div class="step-description" data-key="permissions.complete.description">Ready to start satellite alignment</div>
                    <button class="btn success focusable" onclick="finishSetup()">
                        <span data-key="permissions.complete.button">Launch Application</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Background -->
    <div id="videoContainer">
        <video id="video" autoplay playsinline muted webkit-playsinline></video>
    </div>
    
    <!-- AR Overlay for Sky Pointing -->
    <div class="ar-overlay">
        <!-- Sky Compass -->
        <div class="sky-compass" id="skyCompass">
            <div class="compass-ring">
                <div class="compass-needle" id="compassNeedle"></div>
                <div class="compass-directions" id="compassDirections">
                    <!-- Generated by JavaScript -->
                </div>
                <div class="direction-label north">N</div>
                <div class="direction-label east">E</div>
                <div class="direction-label south">S</div>
                <div class="direction-label west">W</div>
            </div>
        </div>

        <!-- Satellite Target -->
        <div class="satellite-target" id="satelliteTarget" style="display: none;">
            <div class="target-ring" id="targetRing">
                <svg class="target-icon" viewBox="0 0 24 24">
                    <path d="M12 2C12.5523 2 13 2.44772 13 3V5C13 5.55228 12.5523 6 12 6C11.4477 6 11 5.55228 11 5V3C11 2.44772 11.4477 2 12 2Z"/>
                    <path d="M12 18C12.5523 18 13 18.4477 13 19V21C13 21.5523 12.5523 22 12 22C11.4477 22 11 21.5523 11 21V19C11 18.4477 11.4477 18 12 18Z"/>
                    <path d="M22 12C22 12.5523 21.5523 13 21 13H19C18.4477 13 18 12.5523 18 12C18 11.4477 18.4477 11 19 11H21C21.5523 11 22 11.4477 22 12Z"/>
                    <path d="M6 12C6 12.5523 5.55228 13 5 13H3C2.44772 13 2 12.5523 2 12C2 11.4477 2.44772 11 3 11H5C5.55228 11 6 11.4477 6 12Z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                <div class="target-label" id="targetLabel">Satellite</div>
            </div>
        </div>

        <!-- Elevation Indicator -->
        <div class="elevation-indicator">
            <div class="elevation-scale">
                <div class="elevation-pointer" id="elevationPointer"></div>
                <div class="elevation-labels">
                    <div class="elevation-label" style="top: 0%;">90¬∞</div>
                    <div class="elevation-label" style="top: 25%;">60¬∞</div>
                    <div class="elevation-label" style="top: 50%;">30¬∞</div>
                    <div class="elevation-label" style="top: 75%;">0¬∞</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toggle Show Button -->
    <button class="toggle-show-btn focusable" id="toggleShowBtn" onclick="showPanels()" aria-label="Show Interface">
        ‚ñ≤
    </button>

    <!-- HUD Interface -->
    <div class="hud-interface">
        <!-- Top Control Panel -->
        <div class="control-panel" id="controlPanel">
            <div class="panel-header">
                <div class="app-logo">
                    <div class="logo-icon">S</div>
                    <div>
                        <div class="app-title">SatAlign Pro Enterprise</div>
                        <div class="app-subtitle">Professional Satellite Alignment</div>
                    </div>
                </div>
                <div class="header-controls">
                    <div class="language-selector">
                        <button class="lang-btn active focusable" onclick="switchLanguage('en')" aria-label="English">EN</button>
                        <button class="lang-btn focusable" onclick="switchLanguage('ar')" aria-label="Arabic">ÿπÿ±</button>
                    </div>
                    <button class="control-btn focusable" id="togglePanels" onclick="togglePanels()" title="Toggle Interface">
                        <span>‚ñº</span>
                    </button>
                </div>
            </div>

            <!-- Device Orientation Guidance -->
            <div class="orientation-guide">
                <div class="orientation-title">
                    üì± <span data-key="guide.title">Device Positioning</span>
                </div>
                <div class="orientation-text" data-key="guide.text">
                    Point your device towards the sky in the direction of the satellite. Keep it vertical and follow the AR indicators.
                </div>
            </div>
            
            <div class="satellite-section">
                <div class="section-label" data-key="interface.satellite.label">
                    üõ∞Ô∏è Satellite Selection
                </div>
                <select id="satelliteSelect" class="satellite-select focusable" aria-label="Select Satellite">
                    <!-- Will be populated by JavaScript -->
                </select>
            </div>
            
            <div class="metrics-section">
                <div class="section-label" data-key="metrics.title">üìä Alignment Metrics</div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label" data-key="metrics.azimuth">Azimuth</div>
                        <div class="metric-value" id="azimuth">--<span class="metric-unit">¬∞</span></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label" data-key="metrics.elevation">Elevation</div>
                        <div class="metric-value" id="elevation">--<span class="metric-unit">¬∞</span></div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label" data-key="metrics.skew">LNB Skew</div>
                        <div class="metric-value" id="skew">--<span class="metric-unit">¬∞</span></div>
                    </div>
                </div>
            </div>
            
            <div class="status-section">
                <div class="section-label" data-key="status.title">üì° Device Status</div>
                <div class="status-grid">
                    <div class="status-card">
                        <div class="status-label" data-key="status.compass">Device Heading</div>
                        <div class="status-value" id="deviceHeading">--¬∞<span class="status-indicator" id="headingIndicator"></span></div>
                    </div>
                    <div class="status-card">
                        <div class="status-label" data-key="status.tilt">Device Tilt</div>
                        <div class="status-value" id="deviceTilt">--¬∞<span class="status-indicator" id="tiltIndicator"></span></div>
                    </div>
                    <div class="status-card">
                        <div class="status-label" data-key="status.accuracy">GPS Accuracy</div>
                        <div class="status-value" id="gpsAccuracy">--m<span class="status-indicator" id="gpsIndicator"></span></div>
                    </div>
                    <div class="status-card">
                        <div class="status-label" data-key="status.declination">Magnetic Decl.</div>
                        <div class="status-value" id="magneticDeclination">--¬∞<span class="status-indicator good"></span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Status Panel -->
        <div class="status-panel" id="statusPanel">
            <div class="alignment-status" id="alignmentStatus" data-key="status.searching">Point device towards sky</div>
            <div class="alignment-details" id="alignmentDetails" data-key="status.instructions">Select a satellite and point your device towards the sky to begin alignment</div>
            <div class="precision-bar">
                <div class="precision-fill" id="precisionFill" style="width: 0%"></div>
            </div>
            <div class="precision-text" id="precisionText" data-key="status.precision">Alignment Precision: 0%</div>
        </div>
    </div>

    <script>
        'use strict';

        // Application Configuration
        const APP_CONFIG = {
            name: 'SatAlign Pro Enterprise',
            version: '3.2.0',
            build: '2024.07.12',
            defaultLanguage: 'en',
            supportedLanguages: ['en', 'ar'],
            debug: false
        };

        // Translation System
        const TRANSLATIONS = {
            en: {
                loading: {
                    title: "Initializing System",
                    details: "Starting up..."
                },
                permissions: {
                    camera: {
                        title: "Camera Access Required",
                        description: "We need camera access to show the sky view for satellite alignment",
                        button: "Grant Camera Access"
                    },
                    location: {
                        title: "Location Access Required", 
                        description: "We need your location to calculate accurate satellite positions",
                        button: "Grant Location Access"
                    },
                    sensors: {
                        title: "Device Sensors Required",
                        description: "We need compass and orientation sensors for accurate positioning",
                        button: "Grant Sensor Access"
                    },
                    complete: {
                        title: "All Permissions Granted",
                        description: "Ready to start satellite alignment",
                        button: "Launch Application"
                    }
                },
                guide: {
                    title: "Device Positioning",
                    text: "Point your device towards the sky in the direction of the satellite. Keep it vertical and follow the AR indicators."
                },
                interface: {
                    satellite: {
                        label: "üõ∞Ô∏è Satellite Selection",
                        placeholder: "-- Select Satellite --"
                    }
                },
                satellites: {
                    arab: "Arab Satellites",
                    european: "European Satellites",
                    other: "Other Satellites"
                },
                metrics: {
                    title: "üìä Alignment Metrics",
                    azimuth: "Azimuth",
                    elevation: "Elevation", 
                    skew: "LNB Skew"
                },
                status: {
                    title: "üì° Device Status",
                    compass: "Device Heading",
                    tilt: "Device Tilt",
                    accuracy: "GPS Accuracy",
                    declination: "Magnetic Decl.",
                    searching: "Point device towards sky",
                    instructions: "Select a satellite and point your device towards the sky to begin alignment",
                    precision: "Alignment Precision",
                    perfect: "Perfect Alignment - Target Locked",
                    excellent: "Excellent Alignment",
                    good: "Good Alignment", 
                    fair: "Fair Alignment",
                    poor: "Adjust Direction",
                    none: "No Signal"
                },
                alignment: {
                    turnRight: "Turn right",
                    turnLeft: "Turn left",
                    tiltUp: "Tilt up",
                    tiltDown: "Tilt down",
                    perfect: "Perfect alignment achieved",
                    distance: "Distance"
                },
                errors: {
                    cameraFailed: "Failed to access camera",
                    locationFailed: "Failed to get location",
                    sensorsFailed: "Failed to access sensors",
                    initFailed: "Initialization failed"
                }
            },
            ar: {
                loading: {
                    title: "ÿ¨ÿßÿ±Ÿä ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ",
                    details: "ÿ®ÿØÿ° ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ..."
                },
                permissions: {
                    camera: {
                        title: "ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ŸÖÿ∑ŸÑŸàÿ®ÿ©",
                        description: "ŸÜÿ≠ÿ™ÿßÿ¨ ŸÑŸÑŸÉÿßŸÖŸäÿ±ÿß ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ≥ŸÖÿßÿ° ŸÑÿ∂ÿ®ÿ∑ ÿßŸÑÿ£ŸÇŸÖÿßÿ± ÿßŸÑÿµŸÜÿßÿπŸäÿ©",
                        button: "ŸÖŸÜÿ≠ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß"
                    },
                    location: {
                        title: "ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÖŸàŸÇÿπ ŸÖÿ∑ŸÑŸàÿ®ÿ©",
                        description: "ŸÜÿ≠ÿ™ÿßÿ¨ ŸÖŸàŸÇÿπŸÉ ŸÑÿ≠ÿ≥ÿßÿ® ŸÖŸàÿßŸÇÿπ ÿßŸÑÿ£ŸÇŸÖÿßÿ± ÿßŸÑÿµŸÜÿßÿπŸäÿ© ÿ®ÿØŸÇÿ©",
                        button: "ŸÖŸÜÿ≠ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑŸÖŸàŸÇÿπ"
                    },
                    sensors: {
                        title: "ÿµŸÑÿßÿ≠Ÿäÿ© ÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑÿßÿ≥ÿ™ÿ¥ÿπÿßÿ± ŸÖÿ∑ŸÑŸàÿ®ÿ©",
                        description: "ŸÜÿ≠ÿ™ÿßÿ¨ ÿßŸÑÿ®ŸàÿµŸÑÿ© ŸàŸÖŸÇŸäÿßÿ≥ ÿßŸÑÿ•ŸÖÿßŸÑÿ© ŸÑŸÑÿ™ŸÖŸàÿ∂ÿπ ÿßŸÑÿØŸÇŸäŸÇ",
                        button: "ŸÖŸÜÿ≠ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿßÿ≥ÿ™ÿ¥ÿπÿßÿ±"
                    },
                    complete: {
                        title: "ÿ™ŸÖ ŸÖŸÜÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™",
                        description: "ÿ¨ÿßŸáÿ≤ ŸÑÿ®ÿØÿ° ÿ∂ÿ®ÿ∑ ÿßŸÑÿ£ŸÇŸÖÿßÿ± ÿßŸÑÿµŸÜÿßÿπŸäÿ©",
                        button: "ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ"
                    }
                },
                guide: {
                    title: "Ÿàÿ∂ÿπŸäÿ© ÿßŸÑÿ¨Ÿáÿßÿ≤",
                    text: "Ÿàÿ¨Ÿá ÿ¨Ÿáÿßÿ≤ŸÉ ŸÜÿ≠Ÿà ÿßŸÑÿ≥ŸÖÿßÿ° ŸÅŸä ÿßÿ™ÿ¨ÿßŸá ÿßŸÑŸÇŸÖÿ± ÿßŸÑÿµŸÜÿßÿπŸä. ÿßÿ≠ÿ™ŸÅÿ∏ ÿ®Ÿá ŸÅŸä Ÿàÿ∂ÿπ ÿπŸÖŸàÿØŸä Ÿàÿßÿ™ÿ®ÿπ ÿßŸÑŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿßŸÑŸÖÿπÿ≤ÿ≤ÿ©."
                },
                interface: {
                    satellite: {
                        label: "üõ∞Ô∏è ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÇŸÖÿ± ÿßŸÑÿµŸÜÿßÿπŸä",
                        placeholder: "-- ÿßÿÆÿ™ÿ± ÿßŸÑŸÇŸÖÿ± ÿßŸÑÿµŸÜÿßÿπŸä --"
                    }
                },
                satellites: {
                    arab: "ÿßŸÑÿ£ŸÇŸÖÿßÿ± ÿßŸÑÿπÿ±ÿ®Ÿäÿ©",
                    european: "ÿßŸÑÿ£ŸÇŸÖÿßÿ± ÿßŸÑÿ£Ÿàÿ±Ÿàÿ®Ÿäÿ©", 
                    other: "ÿ£ŸÇŸÖÿßÿ± ÿ£ÿÆÿ±Ÿâ"
                },
                metrics: {
                    title: "üìä ŸÖŸÇÿßŸäŸäÿ≥ ÿßŸÑÿ™Ÿàÿ¨ŸäŸá",
                    azimuth: "ÿßŸÑÿßÿ™ÿ¨ÿßŸá",
                    elevation: "ÿßŸÑÿßÿ±ÿ™ŸÅÿßÿπ",
                    skew: "ÿßŸÜÿ≠ÿ±ÿßŸÅ LNB"
                },
                status: {
                    title: "üì° ÿ≠ÿßŸÑÿ© ÿßŸÑÿ¨Ÿáÿßÿ≤",
                    compass: "ÿ®ŸàÿµŸÑÿ© ÿßŸÑÿ¨Ÿáÿßÿ≤",
                    tilt: "ÿ•ŸÖÿßŸÑÿ© ÿßŸÑÿ¨Ÿáÿßÿ≤",
                    accuracy: "ÿØŸÇÿ© GPS",
                    declination: "ÿßŸÑÿßŸÜÿ≠ÿ±ÿßŸÅ ÿßŸÑŸÖÿ∫ŸÜÿßÿ∑Ÿäÿ≥Ÿä",
                    searching: "Ÿàÿ¨Ÿá ÿßŸÑÿ¨Ÿáÿßÿ≤ ŸÜÿ≠Ÿà ÿßŸÑÿ≥ŸÖÿßÿ°",
                    instructions: "ÿßÿÆÿ™ÿ± ŸÇŸÖÿ± ÿµŸÜÿßÿπŸä ŸàŸàÿ¨Ÿá ÿ¨Ÿáÿßÿ≤ŸÉ ŸÜÿ≠Ÿà ÿßŸÑÿ≥ŸÖÿßÿ° ŸÑÿ®ÿØÿ° ÿßŸÑÿ™Ÿàÿ¨ŸäŸá",
                    precision: "ÿØŸÇÿ© ÿßŸÑÿ™Ÿàÿ¨ŸäŸá",
                    perfect: "ÿ™Ÿàÿ¨ŸäŸá ŸÖÿ´ÿßŸÑŸä - ÿ™ŸÖ ÿ™ÿ£ŸÖŸäŸÜ ÿßŸÑŸáÿØŸÅ",
                    excellent: "ÿ™Ÿàÿ¨ŸäŸá ŸÖŸÖÿ™ÿßÿ≤",
                    good: "ÿ™Ÿàÿ¨ŸäŸá ÿ¨ŸäÿØ",
                    fair: "ÿ™Ÿàÿ¨ŸäŸá ŸÖÿ™Ÿàÿ≥ÿ∑", 
                    poor: "ÿßÿ∂ÿ®ÿ∑ ÿßŸÑÿßÿ™ÿ¨ÿßŸá",
                    none: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ¥ÿßÿ±ÿ©"
                },
                alignment: {
                    turnRight: "ÿßÿ≥ÿ™ÿØÿ± ŸäŸÖŸäŸÜÿßŸã",
                    turnLeft: "ÿßÿ≥ÿ™ÿØÿ± Ÿäÿ≥ÿßÿ±ÿßŸã", 
                    tiltUp: "ÿßÿ™ÿ¨Ÿá ŸÑŸÑÿ£ÿπŸÑŸâ",
                    tiltDown: "ÿßÿ™ÿ¨Ÿá ŸÑŸÑÿ£ÿ≥ŸÅŸÑ",
                    perfect: "ÿ™ŸÖ ÿ™ÿ≠ŸÇŸäŸÇ ÿßŸÑÿ™Ÿàÿ¨ŸäŸá ÿßŸÑŸÖÿ´ÿßŸÑŸä",
                    distance: "ÿßŸÑŸÖÿ≥ÿßŸÅÿ©"
                },
                errors: {
                    cameraFailed: "ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÉÿßŸÖŸäÿ±ÿß",
                    locationFailed: "ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ",
                    sensorsFailed: "ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖÿ≥ÿ™ÿ¥ÿπÿ±ÿßÿ™",
                    initFailed: "ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑÿ™ŸáŸäÿ¶ÿ©"
                }
            }
        };

        // Enhanced Satellite Database with Corrected Positions
        const SATELLITE_DATABASE = {
            // Arab Satellites
            'nilesat-201': {
                name: { en: 'Nilesat 201', ar: 'ŸÜÿßŸäŸÑ ÿ≥ÿßÿ™ 201' },
                longitude: -7.0,
                description: { 
                    en: 'Primary satellite for Middle East and North Africa broadcasting',
                    ar: 'ÿßŸÑŸÇŸÖÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ŸÑŸÑÿ®ÿ´ ŸÅŸä ÿßŸÑÿ¥ÿ±ŸÇ ÿßŸÑÿ£Ÿàÿ≥ÿ∑ Ÿàÿ¥ŸÖÿßŸÑ ÿ£ŸÅÿ±ŸäŸÇŸäÿß'
                },
                frequencies: ['11747 H', '11766 V', '11785 H', '11804 V'],
                operator: { en: 'Egyptian Satellite Company', ar: 'ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿßŸÑŸÖÿµÿ±Ÿäÿ© ŸÑŸÑÿ£ŸÇŸÖÿßÿ± ÿßŸÑÿµŸÜÿßÿπŸäÿ©' }
            },
            'nilesat-301': {
                name: { en: 'Nilesat 301', ar: 'ŸÜÿßŸäŸÑ ÿ≥ÿßÿ™ 301' },
                longitude: -7.0,
                description: { 
                    en: 'Latest Nilesat with advanced digital broadcasting',
                    ar: 'ÿ£ÿ≠ÿØÿ´ ÿ£ŸÇŸÖÿßÿ± ŸÜÿßŸäŸÑ ÿ≥ÿßÿ™ ÿ®ÿßŸÑÿ®ÿ´ ÿßŸÑÿ±ŸÇŸÖŸä ÿßŸÑŸÖÿ™ŸÇÿØŸÖ'
                },
                frequencies: ['11823 H', '11842 V', '11861 H', '11880 V'],
                operator: { en: 'Egyptian Satellite Company', ar: 'ÿßŸÑÿ¥ÿ±ŸÉÿ© ÿßŸÑŸÖÿµÿ±Ÿäÿ© ŸÑŸÑÿ£ŸÇŸÖÿßÿ± ÿßŸÑÿµŸÜÿßÿπŸäÿ©' }
            },
            'arabsat-5a': {
                name: { en: 'Arabsat 5A (Badr-4)', ar: 'ÿπÿ±ÿ®ÿ≥ÿßÿ™ 5A (ÿ®ÿØÿ±-4)' },
                longitude: 30.5,
                description: { 
                    en: 'Advanced satellite covering MENA and Europe',
                    ar: 'ŸÇŸÖÿ± ŸÖÿ™ÿ∑Ÿàÿ± Ÿäÿ∫ÿ∑Ÿä ÿßŸÑÿ¥ÿ±ŸÇ ÿßŸÑÿ£Ÿàÿ≥ÿ∑ Ÿàÿ£Ÿàÿ±Ÿàÿ®ÿß'
                },
                frequencies: ['11996 V', '12015 H', '12034 V', '12053 H'],
                operator: { en: 'Arabsat', ar: 'ÿπÿ±ÿ®ÿ≥ÿßÿ™' }
            },
            'arabsat-5c': {
                name: { en: 'Arabsat 5C (Badr-5)', ar: 'ÿπÿ±ÿ®ÿ≥ÿßÿ™ 5C (ÿ®ÿØÿ±-5)' },
                longitude: 20.0,
                description: { 
                    en: 'Premium broadcasting services for Arab region',
                    ar: 'ÿÆÿØŸÖÿßÿ™ ÿ®ÿ´ ŸÅÿßÿ¶ŸÇÿ© ŸÑŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©'
                },
                frequencies: ['11900 V', '11919 H', '11938 V', '11957 H'],
                operator: { en: 'Arabsat', ar: 'ÿπÿ±ÿ®ÿ≥ÿßÿ™' }
            },
            'badr-6': {
                name: { en: 'Badr 6 (Arabsat-6A)', ar: 'ÿ®ÿØÿ± 6 (ÿπÿ±ÿ®ÿ≥ÿßÿ™-6A)' },
                longitude: 26.0,
                description: { 
                    en: 'Latest generation Badr satellite',
                    ar: 'ÿ£ÿ≠ÿØÿ´ ÿ¨ŸäŸÑ ŸÖŸÜ ÿ£ŸÇŸÖÿßÿ± ÿ®ÿØÿ±'
                },
                frequencies: ['12110 V', '12129 H', '12148 V', '12167 H'],
                operator: { en: 'Arabsat', ar: 'ÿπÿ±ÿ®ÿ≥ÿßÿ™' }
            },
            'badr-7': {
                name: { en: 'Badr 7 (Arabsat-6B)', ar: 'ÿ®ÿØÿ± 7 (ÿπÿ±ÿ®ÿ≥ÿßÿ™-6B)' },
                longitude: 26.0,
                description: { 
                    en: 'Ultra-modern satellite technology',
                    ar: 'ÿ™ŸÇŸÜŸäÿ© ÿßŸÑÿ£ŸÇŸÖÿßÿ± ŸÅÿßÿ¶ŸÇÿ© ÿßŸÑÿ≠ÿØÿßÿ´ÿ©'
                },
                frequencies: ['12205 H', '12224 V', '12243 H', '12262 V'],
                operator: { en: 'Arabsat', ar: 'ÿπÿ±ÿ®ÿ≥ÿßÿ™' }
            },

            // European Satellites
            'hotbird-13f': {
                name: { en: 'Hotbird 13F', ar: 'ŸáŸàÿ™ ÿ®Ÿäÿ±ÿØ 13F' },
                longitude: 13.0,
                description: { 
                    en: 'Primary European broadcasting satellite',
                    ar: 'ÿßŸÑŸÇŸÖÿ± ÿßŸÑÿ£Ÿàÿ±Ÿàÿ®Ÿä ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ŸÑŸÑÿ®ÿ´'
                },
                frequencies: ['10723 H', '10742 V', '10761 H', '10780 V'],
                operator: { en: 'Eutelsat', ar: 'ŸäŸàÿ™ŸÑÿ≥ÿßÿ™' }
            },
            'hotbird-13g': {
                name: { en: 'Hotbird 13G', ar: 'ŸáŸàÿ™ ÿ®Ÿäÿ±ÿØ 13G' },
                longitude: 13.0,
                description: { 
                    en: 'Next-generation Hotbird satellite',
                    ar: 'ÿßŸÑÿ¨ŸäŸÑ ÿßŸÑÿ™ÿßŸÑŸä ŸÖŸÜ ŸáŸàÿ™ ÿ®Ÿäÿ±ÿØ'
                },
                frequencies: ['10818 V', '10837 H', '10856 V', '10875 H'],
                operator: { en: 'Eutelsat', ar: 'ŸäŸàÿ™ŸÑÿ≥ÿßÿ™' }
            },
            'astra-1kr': {
                name: { en: 'Astra 1KR', ar: 'ÿ£ÿ≥ÿ™ÿ±ÿß 1KR' },
                longitude: 19.2,
                description: { 
                    en: 'Advanced European satellite for HD broadcasting',
                    ar: 'ŸÇŸÖÿ± ÿ£Ÿàÿ±Ÿàÿ®Ÿä ŸÖÿ™ŸÇÿØŸÖ ŸÑŸÑÿ®ÿ´ ÿπÿßŸÑŸä ÿßŸÑÿØŸÇÿ©'
                },
                frequencies: ['10714 H', '10744 V', '10773 H', '10803 V'],
                operator: { en: 'SES', ar: 'ÿ•ÿ≥ ÿ•Ÿä ÿ•ÿ≥' }
            },
            'astra-1l': {
                name: { en: 'Astra 1L', ar: 'ÿ£ÿ≥ÿ™ÿ±ÿß 1L' },
                longitude: 19.2,
                description: { 
                    en: 'Modern Astra satellite with enhanced capacity',
                    ar: 'ŸÇŸÖÿ± ÿ£ÿ≥ÿ™ÿ±ÿß ÿ≠ÿØŸäÿ´ ÿ®ÿ≥ÿπÿ© ŸÖÿ≠ÿ≥ŸÜÿ©'
                },
                frequencies: ['10862 V', '10891 H', '10920 V', '10949 H'],
                operator: { en: 'SES', ar: 'ÿ•ÿ≥ ÿ•Ÿä ÿ•ÿ≥' }
            },
            'eutelsat-16a': {
                name: { en: 'Eutelsat 16A', ar: 'ŸäŸàÿ™ŸÑÿ≥ÿßÿ™ 16A' },
                longitude: 16.0,
                description: { 
                    en: 'Comprehensive European satellite',
                    ar: 'ŸÇŸÖÿ± ÿ£Ÿàÿ±Ÿàÿ®Ÿä ÿ¥ÿßŸÖŸÑ'
                },
                frequencies: ['11595 H', '11623 V', '11652 H', '11680 V'],
                operator: { en: 'Eutelsat', ar: 'ŸäŸàÿ™ŸÑÿ≥ÿßÿ™' }
            },

            // Other International Satellites
            'turksat-4a': {
                name: { en: 'Turksat 4A', ar: 'ÿ™Ÿàÿ±ŸÉ ÿ≥ÿßÿ™ 4A' },
                longitude: 42.0,
                description: { 
                    en: 'Primary Turkish satellite',
                    ar: 'ÿßŸÑŸÇŸÖÿ± ÿßŸÑÿ™ÿ±ŸÉŸä ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä'
                },
                frequencies: ['11957 V', '11975 H', '12034 V', '12053 H'],
                operator: { en: 'Turksat', ar: 'ÿ™Ÿàÿ±ŸÉ ÿ≥ÿßÿ™' }
            },
            'turksat-4b': {
                name: { en: 'Turksat 4B', ar: 'ÿ™Ÿàÿ±ŸÉ ÿ≥ÿßÿ™ 4B' },
                longitude: 42.0,
                description: { 
                    en: 'Advanced Turksat satellite',
                    ar: 'ŸÇŸÖÿ± ÿ™Ÿàÿ±ŸÉ ÿ≥ÿßÿ™ ŸÖÿ™ŸÇÿØŸÖ'
                },
                frequencies: ['12091 H', '12110 V', '12129 H', '12148 V'],
                operator: { en: 'Turksat', ar: 'ÿ™Ÿàÿ±ŸÉ ÿ≥ÿßÿ™' }
            },
            'hispasat-30w-6': {
                name: { en: 'Hispasat 30W-6', ar: 'ŸáŸäÿ≥ÿ®ÿßÿ≥ÿßÿ™ 30W-6' },
                longitude: -30.0,
                description: { 
                    en: 'Atlantic satellite covering Americas and Europe',
                    ar: 'ŸÇŸÖÿ± ÿ£ÿ∑ŸÑÿ≥Ÿä Ÿäÿ∫ÿ∑Ÿä ÿßŸÑÿ£ŸÖÿ±ŸäŸÉÿ™ŸäŸÜ Ÿàÿ£Ÿàÿ±Ÿàÿ®ÿß'
                },
                frequencies: ['11876 H', '11934 V', '11992 H', '12051 V'],
                operator: { en: 'Hispasat', ar: 'ŸáŸäÿ≥ÿ®ÿßÿ≥ÿßÿ™' }
            },
            'intelsat-33e': {
                name: { en: 'Intelsat 33e', ar: 'ÿ•ŸÜÿ™ŸÑÿ≥ÿßÿ™ 33e' },
                longitude: 60.0,
                description: { 
                    en: 'High-throughput satellite for Asia Pacific',
                    ar: 'ŸÇŸÖÿ± ÿπÿßŸÑŸä ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨Ÿäÿ© ŸÑÿ¢ÿ≥Ÿäÿß ÿßŸÑŸÖÿ≠Ÿäÿ∑ ÿßŸÑŸáÿßÿØÿ¶'
                },
                frequencies: ['11135 H', '11175 V', '11215 H', '11255 V'],
                operator: { en: 'Intelsat', ar: 'ÿ•ŸÜÿ™ŸÑÿ≥ÿßÿ™' }
            },
            'amos-17': {
                name: { en: 'Amos 17', ar: 'ÿπÿßŸÖŸàÿ≥ 17' },
                longitude: 17.0,
                description: { 
                    en: 'Modern satellite covering Africa and Middle East',
                    ar: 'ŸÇŸÖÿ± ÿ≠ÿØŸäÿ´ Ÿäÿ∫ÿ∑Ÿä ÿ£ŸÅÿ±ŸäŸÇŸäÿß ŸàÿßŸÑÿ¥ÿ±ŸÇ ÿßŸÑÿ£Ÿàÿ≥ÿ∑'
                },
                frequencies: ['10843 V', '10883 H', '10923 V', '10963 H'],
                operator: { en: 'Spacecom', ar: 'ÿ≥ÿ®Ÿäÿ≥ ŸÉŸàŸÖ' }
            }
        };

        // Main Application Class
        class SatelliteAlignmentApp {
            constructor() {
                this.currentLanguage = APP_CONFIG.defaultLanguage;
                this.panelsCollapsed = false;
                this.permissions = {
                    camera: false,
                    location: false,
                    orientation: false
                };
                this.deviceData = {
                    heading: 0,
                    tilt: 0,
                    roll: 0,
                    calibrationOffset: 0,
                    isCalibrated: false,
                    lastUpdate: 0
                };
                this.locationData = {
                    latitude: null,
                    longitude: null,
                    accuracy: null,
                    magneticDeclination: 0
                };
                this.selectedSatellite = null;
                this.updateInterval = null;
                this.orientationInterval = null;
                this.isInitialized = false;
                this.hasOrientationPermission = false;

                // Device Detection
                this.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                this.isAndroid = /Android/.test(navigator.userAgent);
                this.isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                
                // Fixed: Improved device detection
                this.isMobile = this.isIOS || this.isAndroid || /Mobi|Android/i.test(navigator.userAgent);
                
                // Bind methods
                this.handleDeviceOrientation = this.handleDeviceOrientation.bind(this);
                this.handleVisibilityChange = this.handleVisibilityChange.bind(this);
                this.handleTouchStart = this.handleTouchStart.bind(this);
                this.handleTouchEnd = this.handleTouchEnd.bind(this);

                this.initializeApp();
            }

            async initializeApp() {
                try {
                    this.log('info', `Initializing SatAlign Pro Enterprise v${APP_CONFIG.version} on ${this.getDeviceInfo()}`);
                    this.initializeElements();
                    this.setupEventListeners();
                    await this.checkInitialPermissions();
                } catch (error) {
                    this.handleError('initFailed', error);
                }
            }

            getDeviceInfo() {
                if (this.isIOS) return 'iOS';
                if (this.isAndroid) return 'Android';
                if (this.isSafari) return 'Safari';
                return 'Desktop';
            }

            initializeElements() {
                this.elements = {
                    loadingScreen: document.getElementById('loadingScreen'),
                    loadingDetails: document.getElementById('loadingDetails'),
                    permissionButtons: document.getElementById('permissionButtons'),
                    video: document.getElementById('video'),
                    satelliteSelect: document.getElementById('satelliteSelect'),
                    skyCompass: document.getElementById('skyCompass'),
                    compassNeedle: document.getElementById('compassNeedle'),
                    satelliteTarget: document.getElementById('satelliteTarget'),
                    targetRing: document.getElementById('targetRing'),
                    targetLabel: document.getElementById('targetLabel'),
                    elevationPointer: document.getElementById('elevationPointer'),
                    controlPanel: document.getElementById('controlPanel'),
                    statusPanel: document.getElementById('statusPanel'),
                    toggleShowBtn: document.getElementById('toggleShowBtn')
                };

                // Generate compass directions
                this.generateCompassDirections();
                
                // Populate satellite selector
                this.populateSatelliteSelector();
            }

            setupEventListeners() {
                // Satellite selection
                this.elements.satelliteSelect.addEventListener('change', (e) => {
                    this.selectedSatellite = e.target.value;
                    this.updateSatelliteTarget();
                });

                // Fixed: Better touch event handling
                if (this.isMobile) {
                    // Touch events for better mobile interaction
                    document.addEventListener('touchstart', this.handleTouchStart, { passive: true });
                    document.addEventListener('touchend', this.handleTouchEnd, { passive: true });
                    
                    // Prevent pinch zoom
                    document.addEventListener('touchmove', (e) => {
                        if (e.touches.length > 1) {
                            e.preventDefault();
                        }
                    }, { passive: false });
                }

                // Orientation change - Fixed with better iOS handling
                window.addEventListener('orientationchange', () => {
                    // Fixed: iOS needs more time for orientation change
                    const delay = this.isIOS ? 1000 : 500;
                    setTimeout(() => {
                        this.updateDisplay();
                        this.handleOrientationChange();
                    }, delay);
                });

                // Visibility change for performance
                document.addEventListener('visibilitychange', this.handleVisibilityChange);

                // Error handling
                window.addEventListener('error', (e) => this.handleError('runtime', e.error));
                window.addEventListener('unhandledrejection', (e) => this.handleError('promise', e.reason));

                // Fixed: iOS specific event handling
                if (this.isIOS) {
                    // Handle iOS device motion
                    window.addEventListener('devicemotion', (e) => {
                        this.handleDeviceMotion(e);
                    });
                    
                    // Handle iOS specific orientation events
                    window.addEventListener('orientationchange', () => {
                        // Reset compass on orientation change for iOS
                        setTimeout(() => {
                            this.deviceData.isCalibrated = false;
                            this.startCalibration();
                        }, 1000);
                    });
                }
            }

            // Fixed: Touch event handlers for better iOS interaction
            handleTouchStart(e) {
                // Add visual feedback for touch interactions
                const target = e.target.closest('button, .focusable');
                if (target && !target.disabled) {
                    target.style.transform = target.style.transform.replace('scale(1)', 'scale(0.98)') || 'scale(0.98)';
                    target.style.opacity = '0.8';
                }
            }

            handleTouchEnd(e) {
                // Remove visual feedback
                const target = e.target.closest('button, .focusable');
                if (target) {
                    setTimeout(() => {
                        target.style.transform = target.style.transform.replace('scale(0.98)', 'scale(1)') || '';
                        target.style.opacity = '';
                    }, 150);
                }
            }

            handleOrientationChange() {
                // Fixed: Handle orientation change properly on mobile devices
                if (this.isMobile) {
                    // Recalibrate compass after orientation change
                    this.deviceData.isCalibrated = false;
                    setTimeout(() => {
                        this.startCalibration();
                    }, 500);
                }
            }

            async checkInitialPermissions() {
                this.updateLoadingText('Checking device capabilities...');
                
                this.log('info', `Device: ${this.getDeviceInfo()}, Mobile: ${this.isMobile}`);

                // For desktop browsers, try auto-permissions
                if (!this.isMobile) {
                    try {
                        await this.requestAllPermissions();
                        await this.completeInitialization();
                        return;
                    } catch (error) {
                        this.log('warn', 'Auto permission failed, showing manual interface');
                    }
                }

                // Show permission interface for mobile devices
                this.elements.permissionButtons.style.display = 'block';
                this.updateLoadingText('Please grant required permissions to continue');
            }

            async requestAllPermissions() {
                // Fixed: Better camera constraints for iOS
                const videoConstraints = {
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920, min: 640 },
                        height: { ideal: 1080, min: 480 }
                    }
                };

                // Fixed: iOS specific camera handling
                if (this.isIOS) {
                    videoConstraints.video = {
                        ...videoConstraints.video,
                        advanced: [
                            { facingMode: 'environment' },
                            { facingMode: { exact: 'environment' } }
                        ]
                    };
                }

                const stream = await navigator.mediaDevices.getUserMedia(videoConstraints);
                stream.getTracks().forEach(track => track.stop());
                this.permissions.camera = true;

                // Request location
                await this.getCurrentLocation();
                this.permissions.location = true;

                // Fixed: iOS orientation permission handling
                await this.requestOrientationPermission();
                this.permissions.orientation = true;

                return true;
            }

            // Fixed: Improved orientation permission handling for iOS
            async requestOrientationPermission() {
                if (this.isIOS && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    try {
                        const permission = await DeviceOrientationEvent.requestPermission();
                        if (permission !== 'granted') {
                            throw new Error('Orientation permission denied');
                        }
                        this.hasOrientationPermission = true;
                    } catch (error) {
                        this.log('error', 'iOS orientation permission failed:', error);
                        throw error;
                    }
                } else {
                    // For Android and other devices
                    this.hasOrientationPermission = true;
                }
                
                return true;
            }

            async getCurrentLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation not supported'));
                        return;
                    }

                    const options = {
                        enableHighAccuracy: true,
                        timeout: this.isMobile ? 20000 : 15000, // Fixed: Longer timeout for mobile
                        maximumAge: 300000
                    };

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            this.locationData.latitude = position.coords.latitude;
                            this.locationData.longitude = position.coords.longitude;
                            this.locationData.accuracy = Math.round(position.coords.accuracy);
                            this.log('info', `Location acquired: ${this.locationData.latitude.toFixed(4)}, ${this.locationData.longitude.toFixed(4)} (¬±${this.locationData.accuracy}m)`);
                            resolve(position);
                        },
                        (error) => {
                            let message = 'Failed to get location';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    message = 'Location permission denied';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    message = 'Location unavailable';
                                    break;
                                case error.TIMEOUT:
                                    message = 'Location timeout';
                                    break;
                            }
                            this.log('error', 'Location error:', message);
                            reject(new Error(message));
                        },
                        options
                    );
                });
            }

            // Enhanced Magnetic Declination Calculation
            calculateMagneticDeclination() {
                if (!this.locationData.latitude || !this.locationData.longitude) {
                    return;
                }

                const lat = this.locationData.latitude;
                const lon = this.locationData.longitude;
                
                // IGRF-13 simplified model for magnetic declination
                const year = new Date().getFullYear();
                const dayOfYear = Math.floor((Date.now() - new Date(year, 0, 0)) / 86400000);
                const decimalYear = year + (dayOfYear - 1) / 365;
                
                const latRad = lat * Math.PI / 180;
                const lonRad = lon * Math.PI / 180;
                
                // Multi-harmonic calculation with improved coefficients
                const term1 = Math.sin(latRad) * Math.cos(lonRad) * 12.5;
                const term2 = Math.cos(latRad) * Math.sin(lonRad) * 8.3;
                const term3 = Math.sin(2 * latRad) * 3.2;
                const term4 = Math.cos(2 * lonRad) * 1.8;
                const term5 = Math.sin(latRad) * Math.sin(lonRad) * 2.1; // Additional term
                
                // Secular variation with location dependency
                const secularVariation = (decimalYear - 2020) * (0.05 + Math.abs(lat) * 0.001);
                
                this.locationData.magneticDeclination = term1 + term2 + term3 + term4 + term5 + secularVariation;
                this.locationData.magneticDeclination = Math.max(-30, Math.min(30, this.locationData.magneticDeclination));
                
                this.log('info', `Magnetic declination calculated: ${this.locationData.magneticDeclination.toFixed(2)}¬∞`);
                
                document.getElementById('magneticDeclination').textContent = 
                    this.locationData.magneticDeclination.toFixed(1) + '¬∞';
            }

            async setupCamera() {
                try {
                    // Fixed: Better camera constraints for iOS
                    const constraints = {
                        video: {
                            facingMode: 'environment', // Back camera for sky pointing
                            width: { ideal: 1920, min: 640 },
                            height: { ideal: 1080, min: 480 },
                            frameRate: { ideal: 30, min: 15 }
                        }
                    };

                    // Fixed: iOS specific camera setup
                    if (this.isIOS) {
                        constraints.video.advanced = [
                            { facingMode: 'environment' }
                        ];
                    }

                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.elements.video.srcObject = stream;
                    
                    // Fixed: iOS video setup
                    this.elements.video.setAttribute('playsinline', true);
                    this.elements.video.setAttribute('webkit-playsinline', true);
                    this.elements.video.muted = true;
                    
                    return new Promise((resolve) => {
                        this.elements.video.onloadedmetadata = () => {
                            this.log('info', `Camera initialized: ${this.elements.video.videoWidth}x${this.elements.video.videoHeight}`);
                            resolve();
                        };
                    });
                } catch (error) {
                    this.log('error', 'Camera setup error:', error);
                    throw new Error(`Camera setup failed: ${error.message}`);
                }
            }

            setupSensors() {
                if (window.DeviceOrientationEvent) {
                    this.log('info', 'Setting up device orientation sensors');
                    
                    // Fixed: iOS specific sensor setup
                    if (this.isIOS && this.hasOrientationPermission) {
                        window.addEventListener('deviceorientation', this.handleDeviceOrientation);
                    } else if (!this.isIOS) {
                        window.addEventListener('deviceorientation', this.handleDeviceOrientation);
                    }
                    
                    this.startCalibration();
                    this.log('info', 'Sensors initialized successfully');
                } else {
                    throw new Error('Device orientation not supported');
                }
            }

            // Fixed: Improved device orientation handler for iOS
            handleDeviceOrientation(event) {
                const now = Date.now();
                
                // Fixed: Throttle updates for better performance
                if (now - this.deviceData.lastUpdate < 50) { // 20 FPS max
                    return;
                }
                this.deviceData.lastUpdate = now;

                if (event.alpha !== null) {
                    let heading = event.alpha;
                    
                    // Fixed: Correct compass reading for both iOS and Android
                    if (this.isIOS) {
                        // iOS: alpha is compass heading (0-360¬∞) but may need adjustment
                        heading = event.alpha;
                        
                        // Fixed: iOS Safari compass correction
                        if (this.isSafari) {
                            // Safari reports webkitCompassHeading if available
                            if (event.webkitCompassHeading !== undefined) {
                                heading = event.webkitCompassHeading;
                            }
                        }
                    } else {
                        // Android: alpha is relative to device orientation
                        heading = (360 - event.alpha) % 360;
                    }
                    
                    // Apply magnetic declination correction
                    heading = (heading + this.locationData.magneticDeclination + 360) % 360;
                    
                    // Apply calibration offset if available
                    if (this.deviceData.isCalibrated) {
                        heading = (heading + this.deviceData.calibrationOffset + 360) % 360;
                    }
                    
                    this.deviceData.heading = heading;
                }
                
                if (event.beta !== null) {
                    // Fixed: Beta is front-to-back tilt (for sky pointing, we want vertical orientation)
                    let tilt = event.beta;
                    
                    // Fixed: iOS vs Android beta handling
                    if (this.isIOS) {
                        // iOS beta ranges from -180 to 180
                        tilt = event.beta;
                    } else {
                        // Android beta ranges from -90 to 90
                        tilt = event.beta;
                    }
                    
                    this.deviceData.tilt = tilt;
                }
                
                if (event.gamma !== null) {
                    // Gamma is left-to-right tilt
                    this.deviceData.roll = event.gamma;
                }
                
                this.updateSensorDisplay();
            }

            // Fixed: iOS device motion handler
            handleDeviceMotion(event) {
                // Additional sensor data from device motion (iOS specific)
                if (event.rotationRate) {
                    // Use rotation rate for better compass stability on iOS
                    const { alpha, beta, gamma } = event.rotationRate;
                    
                    // Apply smoothing filter for iOS
                    if (Math.abs(alpha) > 5 || Math.abs(beta) > 5 || Math.abs(gamma) > 5) {
                        // Device is moving rapidly, reduce update frequency
                        return;
                    }
                }
            }

            startCalibration() {
                this.log('info', 'Starting compass calibration');
                
                let samples = [];
                let sampleCount = 0;
                const maxSamples = this.isIOS ? 50 : 30; // More samples for iOS
                
                const calibrationInterval = setInterval(() => {
                    if (this.deviceData.heading !== 0 && sampleCount < maxSamples) {
                        samples.push(this.deviceData.heading);
                        sampleCount++;
                        
                        // Fixed: Progress feedback during calibration
                        this.updateLoadingText(`Calibrating compass... ${Math.round((sampleCount / maxSamples) * 100)}%`);
                    }
                    
                    if (sampleCount >= maxSamples) {
                        // Calculate median for more stable calibration
                        samples.sort((a, b) => a - b);
                        const median = samples[Math.floor(samples.length / 2)];
                        
                        // Fixed: Better calibration calculation
                        const variance = this.calculateVariance(samples);
                        
                        if (variance < 100) { // Good calibration
                            this.deviceData.calibrationOffset = 0; // Can be enhanced with true north reference
                            this.deviceData.isCalibrated = true;
                            this.log('info', `Compass calibrated successfully. Variance: ${variance.toFixed(2)}`);
                        } else {
                            this.log('warn', 'Compass calibration has high variance, may be unstable');
                            this.deviceData.isCalibrated = true; // Continue anyway
                        }
                        
                        clearInterval(calibrationInterval);
                    }
                }, 100);
                
                // Timeout after 20 seconds (longer for iOS)
                setTimeout(() => {
                    if (!this.deviceData.isCalibrated) {
                        this.deviceData.isCalibrated = true;
                        this.log('warn', 'Compass calibration timed out');
                        clearInterval(calibrationInterval);
                    }
                }, this.isIOS ? 20000 : 15000);
            }

            calculateVariance(values) {
                const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
                const squareDiffs = values.map(val => Math.pow(val - mean, 2));
                return squareDiffs.reduce((sum, sq) => sum + sq, 0) / values.length;
            }

            generateCompassDirections() {
                const container = document.getElementById('compassDirections');
                container.innerHTML = '';
                
                for (let i = 0; i < 360; i += 15) {
                    const mark = document.createElement('div');
                    mark.className = 'direction-marker';
                    
                    if (i % 90 === 0) {
                        mark.classList.add('major');
                        if (i === 0) mark.classList.add('north');
                    }
                    
                    mark.style.transform = `translateX(-50%) rotate(${i}deg)`;
                    container.appendChild(mark);
                }
            }

            populateSatelliteSelector() {
                const select = this.elements.satelliteSelect;
                select.innerHTML = '';
                
                // Add placeholder
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = this.t('interface.satellite.placeholder', '-- Select Satellite --');
                select.appendChild(placeholder);

                // Group satellites
                const groups = {
                    arab: ['nilesat-201', 'nilesat-301', 'arabsat-5a', 'arabsat-5c', 'badr-6', 'badr-7'],
                    european: ['hotbird-13f', 'hotbird-13g', 'astra-1kr', 'astra-1l', 'eutelsat-16a'],
                    other: ['turksat-4a', 'turksat-4b', 'hispasat-30w-6', 'intelsat-33e', 'amos-17']
                };

                // Add grouped options
                Object.entries(groups).forEach(([groupKey, satelliteKeys]) => {
                    if (satelliteKeys.length === 0) return;
                    
                    const group = document.createElement('optgroup');
                    group.label = this.t(`satellites.${groupKey}`, groupKey);
                    
                    satelliteKeys.forEach(key => {
                        if (SATELLITE_DATABASE[key]) {
                            const satellite = SATELLITE_DATABASE[key];
                            const option = document.createElement('option');
                            option.value = key;
                            const name = satellite.name[this.currentLanguage] || satellite.name.en;
                            const pos = satellite.longitude >= 0 ? `${satellite.longitude}¬∞E` : `${Math.abs(satellite.longitude)}¬∞W`;
                            option.textContent = `${name} (${pos})`;
                            group.appendChild(option);
                        }
                    });
                    
                    select.appendChild(group);
                });
            }

            // Fixed: Improved satellite position calculation for better accuracy
            calculateSatellitePosition(satelliteLongitude) {
                if (!this.locationData.latitude || !this.locationData.longitude) {
                    return null;
                }

                const userLatRad = this.locationData.latitude * Math.PI / 180;
                const userLonRad = this.locationData.longitude * Math.PI / 180;
                const satLonRad = satelliteLongitude * Math.PI / 180;
                const deltaLon = satLonRad - userLonRad;

                // Geostationary orbit calculations with improved precision
                const earthRadius = 6371000; // meters
                const satAltitude = 35786000; // meters  
                const satOrbitRadius = earthRadius + satAltitude;

                const cosUserLat = Math.cos(userLatRad);
                const sinUserLat = Math.sin(userLatRad);
                const cosDeltaLon = Math.cos(deltaLon);
                const sinDeltaLon = Math.sin(deltaLon);

                // Fixed: Correct azimuth calculation for sky pointing
                const azimuthRad = Math.atan2(sinDeltaLon, Math.tan(0) - sinUserLat * cosDeltaLon / cosUserLat);
                let azimuth = (azimuthRad * 180 / Math.PI + 360) % 360;

                // Fixed: More accurate elevation calculation
                const earthCenterDistance = earthRadius * Math.acos(sinUserLat * Math.sin(0) + cosUserLat * Math.cos(0) * cosDeltaLon);
                const slantRange = Math.sqrt(
                    Math.pow(satOrbitRadius, 2) + 
                    Math.pow(earthRadius, 2) - 
                    2 * satOrbitRadius * earthRadius * Math.cos(earthCenterDistance / earthRadius)
                );
                
                const elevationRad = Math.acos((Math.pow(earthRadius, 2) + Math.pow(slantRange, 2) - Math.pow(satOrbitRadius, 2)) / (2 * earthRadius * slantRange)) - Math.PI / 2;
                const elevation = Math.max(0, elevationRad * 180 / Math.PI);

                // Fixed: LNB skew calculation with proper sign
                const skewRad = Math.atan2(Math.sin(deltaLon) * Math.cos(0), Math.cos(userLatRad) * Math.tan(0) - Math.sin(userLatRad) * Math.cos(deltaLon));
                const skew = skewRad * 180 / Math.PI;

                return {
                    azimuth: Math.round(azimuth * 100) / 100,
                    elevation: Math.round(elevation * 100) / 100,
                    skew: Math.round(skew * 100) / 100,
                    distance: Math.round(slantRange / 1000),
                    valid: elevation > 0
                };
            }

            updateDisplay() {
                if (!this.selectedSatellite || !this.locationData.latitude) {
                    this.updateAlignmentStatus(
                        this.t('status.searching', 'Point device towards sky'),
                        this.t('status.instructions', 'Select a satellite and point your device towards the sky to begin alignment'), 
                        0
                    );
                    return;
                }

                const satellite = SATELLITE_DATABASE[this.selectedSatellite];
                const position = this.calculateSatellitePosition(satellite.longitude);

                if (!position || !position.valid) {
                    this.updateAlignmentStatus(
                        'Satellite Not Visible',
                        'Satellite is below horizon from your location', 
                        0
                    );
                    return;
                }

                // Update metrics display
                document.getElementById('azimuth').innerHTML = `${position.azimuth.toFixed(1)}<span class="metric-unit">¬∞</span>`;
                document.getElementById('elevation').innerHTML = `${position.elevation.toFixed(1)}<span class="metric-unit">¬∞</span>`;
                document.getElementById('skew').innerHTML = `${position.skew.toFixed(1)}<span class="metric-unit">¬∞</span>`;

                // Fixed: Better alignment precision calculation
                const headingDiff = this.calculateAngleDifference(this.deviceData.heading, position.azimuth);
                const tiltDiff = Math.abs(this.deviceData.tilt - position.elevation);
                
                // Improved accuracy calculation with weighted factors
                const azimuthAccuracy = Math.max(0, 100 - (headingDiff * 3));
                const elevationAccuracy = Math.max(0, 100 - (tiltDiff * 5));
                const overallAccuracy = (azimuthAccuracy * 0.7 + elevationAccuracy * 0.3); // Azimuth is more important

                this.updateAlignmentStatus(
                    this.getAlignmentStatusText(overallAccuracy),
                    this.getAlignmentDetails(headingDiff, tiltDiff, position),
                    overallAccuracy
                );

                // Update sky compass and satellite target
                this.updateSkyCompass();
                this.updateSatelliteTarget();
                this.updateElevationIndicator(position.elevation);
            }

            calculateAngleDifference(angle1, angle2) {
                let diff = Math.abs(angle1 - angle2);
                return Math.min(diff, 360 - diff);
            }

            getAlignmentStatusText(accuracy) {
                if (accuracy >= 95) return this.t('status.perfect', 'Perfect Alignment - Target Locked');
                if (accuracy >= 85) return this.t('status.excellent', 'Excellent Alignment');
                if (accuracy >= 70) return this.t('status.good', 'Good Alignment');
                if (accuracy >= 50) return this.t('status.fair', 'Fair Alignment');
                if (accuracy >= 30) return this.t('status.poor', 'Adjust Direction');
                return this.t('status.none', 'No Signal');
            }

            getAlignmentDetails(headingDiff, tiltDiff, position) {
                let details = [];
                
                if (headingDiff > 2) {
                    const direction = this.deviceData.heading < position.azimuth ? 
                        this.t('alignment.turnRight', 'Turn right') : 
                        this.t('alignment.turnLeft', 'Turn left');
                    details.push(`${direction} ${Math.round(headingDiff)}¬∞`);
                }
                
                if (tiltDiff > 1) {
                    const direction = this.deviceData.tilt < position.elevation ? 
                        this.t('alignment.tiltUp', 'Tilt up') : 
                        this.t('alignment.tiltDown', 'Tilt down');
                    details.push(`${direction} ${Math.round(tiltDiff)}¬∞`);
                }
                
                if (details.length === 0) {
                    details.push(this.t('alignment.perfect', 'Perfect alignment achieved'));
                }
                
                details.push(`${this.t('alignment.distance', 'Distance')}: ${position.distance} km`);
                
                return details.join(' ‚Ä¢ ');
            }

            updateAlignmentStatus(status, details, accuracy) {
                document.getElementById('alignmentStatus').textContent = status;
                document.getElementById('alignmentDetails').textContent = details;
                
                const precisionFill = document.getElementById('precisionFill');
                const precisionText = document.getElementById('precisionText');
                
                precisionFill.style.width = accuracy + '%';
                precisionText.textContent = `${this.t('status.precision', 'Alignment Precision')}: ${Math.round(accuracy)}%`;
            }

            updateSensorDisplay() {
                // Update heading indicator
                document.getElementById('deviceHeading').innerHTML = 
                    `${this.deviceData.heading.toFixed(0)}¬∞<span class="status-indicator ${this.deviceData.isCalibrated ? 'good' : ''}" id="headingIndicator"></span>`;
                
                // Update tilt indicator (for sky pointing, optimal tilt is around 30-90¬∞)
                const tiltStatus = (Math.abs(this.deviceData.tilt) > 30 && Math.abs(this.deviceData.tilt) < 90) ? 'good' : 'warning';
                document.getElementById('deviceTilt').innerHTML = 
                    `${this.deviceData.tilt.toFixed(0)}¬∞<span class="status-indicator ${tiltStatus}" id="tiltIndicator"></span>`;
                
                // Update GPS accuracy
                if (this.locationData.accuracy) {
                    const gpsStatus = this.locationData.accuracy < 20 ? 'good' : this.locationData.accuracy < 50 ? 'warning' : '';
                    document.getElementById('gpsAccuracy').innerHTML = 
                        `${this.locationData.accuracy}m<span class="status-indicator ${gpsStatus}" id="gpsIndicator"></span>`;
                }
            }

            updateSkyCompass() {
                // Fixed: Update compass needle direction with smooth animation
                const needle = this.elements.compassNeedle;
                const rotation = this.deviceData.heading;
                needle.style.transform = `rotate(${rotation}deg)`;
            }

            // Fixed: Improved satellite target positioning for mobile devices
            updateSatelliteTarget() {
                if (!this.selectedSatellite || !this.locationData.latitude) {
                    this.elements.satelliteTarget.style.display = 'none';
                    return;
                }

                const satellite = SATELLITE_DATABASE[this.selectedSatellite];
                const position = this.calculateSatellitePosition(satellite.longitude);

                if (!position || !position.valid) {
                    this.elements.satelliteTarget.style.display = 'none';
                    return;
                }

                // Fixed: Calculate position on screen for sky pointing with mobile optimization
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;

                // Relative angles from device orientation to satellite
                const relativeAzimuth = position.azimuth - this.deviceData.heading;
                const relativeElevation = position.elevation - this.deviceData.tilt;

                // Fixed: Convert to screen coordinates with improved sensitivity for mobile
                const sensitivity = this.isMobile ? 4 : 6; // Higher sensitivity for mobile
                const x = screenWidth / 2 + (relativeAzimuth * screenWidth / (60 * sensitivity));
                const y = screenHeight / 2 - (relativeElevation * screenHeight / (60 * sensitivity));

                // Fixed: Better clamping for mobile screens
                const margin = this.isMobile ? 60 : 80;
                const clampedX = Math.max(margin, Math.min(screenWidth - margin, x));
                const clampedY = Math.max(margin + 40, Math.min(screenHeight - margin - 40, y));

                // Position the target
                this.elements.satelliteTarget.style.left = clampedX + 'px';
                this.elements.satelliteTarget.style.top = clampedY + 'px';
                this.elements.satelliteTarget.style.display = 'block';

                // Update target appearance based on alignment
                const headingDiff = this.calculateAngleDifference(this.deviceData.heading, position.azimuth);
                const tiltDiff = Math.abs(this.deviceData.tilt - position.elevation);
                
                this.elements.targetRing.className = 'target-ring';
                if (headingDiff < 2 && tiltDiff < 2) {
                    this.elements.targetRing.classList.add('aligned');
                } else if (headingDiff < 5 && tiltDiff < 5) {
                    this.elements.targetRing.classList.add('close');
                }

                // Update target label
                const satName = satellite.name[this.currentLanguage] || satellite.name.en;
                this.elements.targetLabel.textContent = satName;
            }

            updateElevationIndicator(targetElevation) {
                // Update elevation pointer position
                const percentage = Math.max(0, Math.min(100, (90 - targetElevation) / 90 * 100));
                this.elements.elevationPointer.style.top = percentage + '%';
            }

            // Interface Controls
            togglePanels() {
                this.panelsCollapsed = !this.panelsCollapsed;
                
                const panels = [this.elements.controlPanel, this.elements.statusPanel];
                const toggleBtn = this.elements.toggleShowBtn;
                
                if (this.panelsCollapsed) {
                    panels.forEach(panel => panel.classList.add('collapsed'));
                    toggleBtn.classList.add('visible');
                } else {
                    panels.forEach(panel => panel.classList.remove('collapsed'));
                    toggleBtn.classList.remove('visible');
                }
                
                // Update toggle button
                const togglePanelsBtn = document.getElementById('togglePanels');
                togglePanelsBtn.innerHTML = this.panelsCollapsed ? '<span>‚ñ≤</span>' : '<span>‚ñº</span>';
            }

            showPanels() {
                if (this.panelsCollapsed) {
                    this.togglePanels();
                }
            }

            // Language Management
            switchLanguage(lang) {
                if (!APP_CONFIG.supportedLanguages.includes(lang)) {
                    return;
                }

                this.currentLanguage = lang;
                
                // Update active language button
                document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
                
                // Fixed: Find correct button by text content
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    if ((lang === 'en' && btn.textContent === 'EN') || 
                        (lang === 'ar' && btn.textContent === 'ÿπÿ±')) {
                        btn.classList.add('active');
                    }
                });
                
                // Update document language and direction
                document.documentElement.lang = lang;
                document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
                document.body.className = lang === 'ar' ? 'rtl' : 'ltr';
                
                // Update all translations
                this.updateTranslations();
                this.populateSatelliteSelector();
                
                // Store preference
                try {
                    localStorage.setItem('satalign_language', lang);
                } catch (e) {
                    // Ignore localStorage errors
                }
            }

            updateTranslations() {
                document.querySelectorAll('[data-key]').forEach(element => {
                    const key = element.getAttribute('data-key');
                    const translation = this.t(key);
                    if (translation) {
                        element.textContent = translation;
                    }
                });
            }

            t(key, fallback = '') {
                const keys = key.split('.');
                let value = TRANSLATIONS[this.currentLanguage];
                
                for (const k of keys) {
                    value = value?.[k];
                    if (!value) break;
                }
                
                return value || fallback || key;
            }

            // Initialization completion
            async completeInitialization() {
                try {
                    this.updateLoadingText('Calculating magnetic declination...');
                    this.calculateMagneticDeclination();
                    
                    this.updateLoadingText('Initializing camera...');
                    await this.setupCamera();
                    
                    this.updateLoadingText('Setting up sensors...');
                    this.setupSensors();
                    
                    this.updateLoadingText('Loading interface...');
                    await this.delay(500);
                    
                    this.updateLoadingText('Complete!');
                    await this.delay(500);
                    
                    this.elements.loadingScreen.style.display = 'none';
                    this.startMainLoop();
                    this.isInitialized = true;
                    
                    this.log('info', 'Application initialized successfully');
                    
                } catch (error) {
                    this.handleError('initFailed', error);
                }
            }

            startMainLoop() {
                // Fixed: Main update loop with adaptive frame rate for mobile
                const frameRate = this.isMobile ? 150 : 100; // Slower on mobile for battery life
                this.updateInterval = setInterval(() => {
                    if (this.isInitialized && !document.hidden) {
                        this.updateDisplay();
                    }
                }, frameRate);

                // Slower updates for UI elements
                setInterval(() => {
                    if (this.isInitialized && !document.hidden) {
                        this.updateSensorDisplay();
                    }
                }, 1000);
            }

            // Utility functions
            updateLoadingText(text) {
                if (this.elements.loadingDetails) {
                    this.elements.loadingDetails.textContent = text;
                }
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            handleVisibilityChange() {
                if (document.hidden) {
                    // Pause updates when app is hidden
                    if (this.updateInterval) {
                        clearInterval(this.updateInterval);
                        this.updateInterval = null;
                    }
                } else {
                    // Resume updates when app becomes visible
                    if (!this.updateInterval && this.isInitialized) {
                        this.startMainLoop();
                    }
                }
            }

            handleError(type, error) {
                const errorMsg = error?.message || error || 'Unknown error';
                this.log('error', `${type}: ${errorMsg}`);
                
                const friendlyMessage = this.t(`errors.${type}`, errorMsg);
                this.showErrorDialog('Error', friendlyMessage);
            }

            showErrorDialog(title, message) {
                const dialog = document.createElement('div');
                dialog.className = 'error-dialog';
                dialog.innerHTML = `
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-title">${title}</div>
                    <div class="error-message">${message}</div>
                    <div class="error-actions">
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.remove()">
                            ${this.t('errors.dismiss', 'Dismiss')}
                        </button>
                        <button class="btn" onclick="window.location.reload()">
                            ${this.t('errors.retry', 'Retry')}
                        </button>
                    </div>
                `;
                document.body.appendChild(dialog);

                setTimeout(() => {
                    if (dialog.parentNode) {
                        dialog.remove();
                    }
                }, 10000);
            }

            log(level, message, ...args) {
                const timestamp = new Date().toISOString();
                const logMessage = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
                
                switch (level) {
                    case 'error':
                        console.error(logMessage, ...args);
                        break;
                    case 'warn':
                        console.warn(logMessage, ...args);
                        break;
                    case 'info':
                        console.info(logMessage, ...args);
                        break;
                    default:
                        console.log(logMessage, ...args);
                }
            }

            destroy() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                }
                
                if (this.orientationInterval) {
                    clearInterval(this.orientationInterval);
                }
                
                if (this.elements.video && this.elements.video.srcObject) {
                    const tracks = this.elements.video.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                }
                
                window.removeEventListener('deviceorientation', this.handleDeviceOrientation);
                document.removeEventListener('visibilitychange', this.handleVisibilityChange);
                
                this.log('info', 'Application destroyed');
            }
        }

        // Global application instance
        let app = null;

        // Global functions for HTML event handlers
        async function requestCameraPermission() {
            const btn = document.getElementById('cameraBtn');
            const locationBtn = document.getElementById('locationBtn');
            
            try {
                btn.textContent = 'Processing...';
                btn.disabled = true;

                // Fixed: Better camera constraints for iOS
                const constraints = { 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920, min: 640 },
                        height: { ideal: 1080, min: 480 }
                    } 
                };

                if (app.isIOS) {
                    constraints.video.advanced = [{ facingMode: 'environment' }];
                }

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                stream.getTracks().forEach(track => track.stop());
                
                btn.textContent = '‚úì Camera Access Granted';
                btn.classList.add('success');
                app.permissions.camera = true;
                
                locationBtn.disabled = false;
                
            } catch (error) {
                btn.textContent = '‚úó Camera Access Failed';
                btn.style.background = 'var(--danger-color)';
                
                setTimeout(() => {
                    btn.textContent = 'Retry Camera Access';
                    btn.style.background = 'var(--primary-color)';
                    btn.disabled = false;
                }, 3000);
            }
        }

        async function requestLocationPermission() {
            const btn = document.getElementById('locationBtn');
            const orientationBtn = document.getElementById('orientationBtn');
            
            try {
                btn.textContent = 'Processing...';
                btn.disabled = true;

                await app.getCurrentLocation();
                
                btn.textContent = '‚úì Location Access Granted';
                btn.classList.add('success');
                app.permissions.location = true;
                
                orientationBtn.disabled = false;
                
            } catch (error) {
                btn.textContent = '‚úó Location Access Failed';
                btn.style.background = 'var(--danger-color)';
                
                setTimeout(() => {
                    btn.textContent = 'Retry Location Access';
                    btn.style.background = 'var(--primary-color)';
                    btn.disabled = false;
                }, 3000);
            }
        }

        async function requestOrientationPermission() {
            const btn = document.getElementById('orientationBtn');
            const startStep = document.getElementById('startStep');
            
            try {
                btn.textContent = 'Processing...';
                btn.disabled = true;

                await app.requestOrientationPermission();
                
                btn.textContent = '‚úì Sensor Access Granted';
                btn.classList.add('success');
                app.permissions.orientation = true;
                
                startStep.style.display = 'block';
                
            } catch (error) {
                btn.textContent = '‚úó Sensor Access Failed';
                btn.style.background = 'var(--danger-color)';
                
                setTimeout(() => {
                    btn.textContent = 'Retry Sensor Access';
                    btn.style.background = 'var(--primary-color)';
                    btn.disabled = false;
                }, 3000);
            }
        }

        async function finishSetup() {
            await app.completeInitialization();
        }

        function switchLanguage(lang) {
            if (app) {
                app.switchLanguage(lang);
            }
        }

        function togglePanels() {
            if (app) {
                app.togglePanels();
            }
        }

        function showPanels() {
            if (app) {
                app.showPanels();
            }
        }

        // Initialize application when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            app = new SatelliteAlignmentApp();
            
            // Load saved language preference
            try {
                const savedLang = localStorage.getItem('satalign_language');
                if (savedLang && APP_CONFIG.supportedLanguages.includes(savedLang)) {
                    // Set initial language but don't trigger full switch during init
                    app.currentLanguage = savedLang;
                    document.documentElement.lang = savedLang;
                    document.documentElement.dir = savedLang === 'ar' ? 'rtl' : 'ltr';
                    document.body.className = savedLang === 'ar' ? 'rtl' : 'ltr';
                    
                    // Update language buttons
                    document.querySelectorAll('.lang-btn').forEach(btn => {
                        btn.classList.remove('active');
                        if ((savedLang === 'en' && btn.textContent === 'EN') || 
                            (savedLang === 'ar' && btn.textContent === 'ÿπÿ±')) {
                            btn.classList.add('active');
                        }
                    });
                }
            } catch (e) {
                // localStorage not available or failed
                console.warn('Could not load language preference:', e);
            }
        });

        // Handle app lifecycle
        window.addEventListener('beforeunload', () => {
            if (app) {
                app.destroy();
            }
        });

        // Fixed: Screen wake lock for professional use with better error handling
        let wakeLock = null;
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').then((lock) => {
                wakeLock = lock;
                console.log('Screen wake lock acquired');
                
                // Handle wake lock release
                lock.addEventListener('release', () => {
                    console.log('Screen wake lock released');
                    wakeLock = null;
                });
            }).catch(err => {
                console.log('Wake lock failed:', err);
            });
        }

        // Handle wake lock on visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && 'wakeLock' in navigator && !wakeLock) {
                navigator.wakeLock.request('screen').then((lock) => {
                    wakeLock = lock;
                    lock.addEventListener('release', () => {
                        wakeLock = null;
                    });
                }).catch(err => {
                    console.log('Wake lock re-acquisition failed:', err);
                });
            }
        });

        // Register Service Worker with better error handling
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('Service Worker registered successfully:', registration);
                    
                    // Listen for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateNotification();
                            }
                        });
                    });
                    
                } catch (error) {
                    console.log('Service Worker registration failed:', error);
                }
            });
        }

        function showUpdateNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--glass-bg);
                backdrop-filter: blur(20px);
                border: 1px solid var(--primary-color);
                border-radius: 12px;
                padding: 16px;
                color: var(--text-primary);
                z-index: 1000;
                font-size: 14px;
                max-width: 300px;
                box-shadow: 0 8px 32px rgba(0,102,204,0.3);
            `;
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">Update Available</div>
                <div style="margin-bottom: 12px; color: var(--text-secondary);">A new version of SatAlign Pro is ready</div>
                <button onclick="window.location.reload()" style="
                    background: var(--primary-color);
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    margin-right: 8px;
                    touch-action: manipulation;
                ">Update Now</button>
                <button onclick="this.parentElement.remove()" style="
                    background: transparent;
                    color: var(--text-secondary);
                    border: 1px solid var(--border-color);
                    padding: 8px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    touch-action: manipulation;
                ">Later</button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 10000);
        }

        // Professional error handling
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            if (app) {
                app.handleError('runtime', event.error);
            }
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            event.preventDefault();
            if (app) {
                app.handleError('promise', event.reason);
            }
        });

        // Professional console branding
        console.log(`
%c‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë               SatAlign Pro Enterprise                     ‚ïë
‚ïë             Professional Satellite Alignment             ‚ïë
‚ïë                                                           ‚ïë
‚ïë    üõ∞Ô∏è  Enterprise-grade precision and reliability        ‚ïë
‚ïë    üì±  Full iOS and Android support                      ‚ïë
‚ïë    üåç  Multi-language interface (EN/AR)                  ‚ïë
‚ïë    üéØ  Sky-pointing AR guidance system                   ‚ïë
‚ïë    üîí  Production-ready architecture                     ‚ïë
‚ïë                                                           ‚ïë
‚ïë    Version: ${APP_CONFIG.version}                                    ‚ïë
‚ïë    Build: ${APP_CONFIG.build}                               ‚ïë
‚ïë    ¬© 2024 SatAlign Pro Enterprise                        ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`, 
            'color: #0066cc; font-family: monospace; font-size: 11px; line-height: 1.4;'
        );

        // Development helper (remove in production)
        if (APP_CONFIG.debug) {
            window.satApp = app;
            console.log('Debug mode: App instance available as window.satApp');
        }
    </script>
</body>
</html>
                
