<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SatAlign Pro Enterprise</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Meta tags for PWA -->
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SatAlign Pro">
    
    <!-- Professional Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3ccircle cx='50' cy='50' r='40' fill='%231a1a1a'/%3e%3ccircle cx='50' cy='50' r='30' fill='none' stroke='%23ffffff' stroke-width='2'/%3e%3ccircle cx='50' cy='30' r='3' fill='%23ffffff'/%3e%3c/svg%3e">
    
    <style>
        :root {
            --primary-color: #1a1a1a;
            --secondary-color: #2d2d2d;
            --accent-color: #0066cc;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.7);
            --text-muted: rgba(255,255,255,0.5);
            --border-color: rgba(255,255,255,0.1);
            --glass-bg: rgba(26,26,26,0.85);
            --glass-border: rgba(255,255,255,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-color);
            color: var(--text-primary);
            overflow: hidden;
            position: relative;
            height: 100vh;
            user-select: none;
            font-weight: 400;
            letter-spacing: -0.01em;
        }

        body.rtl {
            direction: rtl;
        }

        body.ltr {
            direction: ltr;
        }

        #video {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            filter: brightness(0.8) contrast(1.1);
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .hud-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 15;
        }

        /* Top Panel with enhanced mobile support */
        .top-panel {
            position: absolute;
            top: env(safe-area-inset-top, 10px);
            left: 10px;
            right: 10px;
            z-index: 20;
            background: var(--glass-bg);
            backdrop-filter: blur(40px);
            border-radius: 16px;
            padding: 16px;
            pointer-events: all;
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            max-height: 85vh;
            overflow-y: auto;
        }

        .top-panel.collapsed {
            transform: translateY(-85%);
            opacity: 0.8;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .app-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .toggle-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: var(--secondary-color);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            min-width: 32px;
        }

        .control-btn:hover {
            background: var(--accent-color);
            transform: scale(1.05);
        }

        .control-btn.active {
            background: var(--accent-color);
        }

        /* Language Toggle */
        .language-toggle {
            background: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 4px;
            display: flex;
            font-size: 12px;
            font-weight: 500;
        }

        .lang-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 40px;
        }

        .lang-btn.active {
            background: var(--accent-color);
            color: var(--text-primary);
        }

        /* Satellite Selector */
        .satellite-selector {
            margin-bottom: 16px;
        }

        .selector-label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--secondary-color);
            color: var(--text-primary);
            font-size: 15px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: left 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-left: 40px;
            transition: all 0.2s;
        }

        .ltr select {
            background-position: right 12px center;
            padding-left: 16px;
            padding-right: 40px;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0,102,204,0.1);
        }

        /* Professional Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }

        .metric-card {
            background: var(--secondary-color);
            border: 1px solid var(--border-color);
            padding: 12px 8px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.2s;
            min-width: 100px;
        }

        .metric-card:hover {
            background: rgba(45,45,45,0.8);
            border-color: var(--accent-color);
        }

        .metric-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        /* Status Grid */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }

        .status-card {
            background: var(--secondary-color);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.2s;
            min-width: 120px;
        }

        .status-label {
            font-size: 9px;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        /* Professional Satellite Marker */
        .satellite-marker {
            position: absolute;
            width: 60px;
            height: 60px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .marker-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .marker-circle {
            width: 100%;
            height: 100%;
            border: 3px solid var(--danger-color);
            border-radius: 50%;
            background: rgba(220,53,69,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: satellitePulse 2s infinite;
            box-shadow: 0 0 20px rgba(220,53,69,0.4);
        }

        .marker-circle.aligned {
            border-color: var(--success-color);
            background: rgba(40,167,69,0.15);
            box-shadow: 0 0 20px rgba(40,167,69,0.4);
        }

        .marker-circle.close {
            border-color: var(--warning-color);
            background: rgba(255,193,7,0.15);
            box-shadow: 0 0 20px rgba(255,193,7,0.4);
        }

        .marker-icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
            color: var(--text-primary);
        }

        .marker-label {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
            border: 1px solid var(--glass-border);
        }

        @keyframes satellitePulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Professional Crosshair */
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .crosshair-circle {
            width: 100%;
            height: 100%;
            border: 2px solid var(--accent-color);
            border-radius: 50%;
            position: relative;
            background: rgba(0,102,204,0.05);
        }

        .crosshair-lines {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .crosshair-h, .crosshair-v {
            position: absolute;
            background: var(--accent-color);
        }

        .crosshair-h {
            width: 40px;
            height: 2px;
            left: -20px;
            top: -1px;
        }

        .crosshair-v {
            width: 2px;
            height: 40px;
            left: -1px;
            top: -20px;
        }

        /* Professional Compass */
        .compass-container {
            position: absolute;
            bottom: env(safe-area-inset-bottom, 20px);
            right: 20px;
            width: 100px;
            height: 100px;
        }

        .compass {
            width: 100%;
            height: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(40px);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .compass-needle {
            position: absolute;
            width: 3px;
            height: 35px;
            background: var(--danger-color);
            top: 15px;
            left: 50%;
            transform-origin: bottom center;
            transform: translateX(-50%);
            border-radius: 2px;
        }

        .compass-markings {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .compass-mark {
            position: absolute;
            width: 2px;
            height: 8px;
            background: var(--text-muted);
            left: 50%;
            top: 5px;
            transform-origin: 50% 45px;
        }

        .compass-mark.major {
            height: 12px;
            width: 3px;
            background: var(--text-primary);
        }

        /* Professional Alignment Panel */
        .alignment-panel {
            position: absolute;
            bottom: env(safe-area-inset-bottom, 20px);
            left: 20px;
            right: 130px;
            background: var(--glass-bg);
            backdrop-filter: blur(40px);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--glass-border);
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .alignment-panel.collapsed {
            transform: translateY(75%);
            opacity: 0.8;
        }

        .alignment-status {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .alignment-details {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .signal-strength {
            width: 100%;
            height: 6px;
            background: var(--secondary-color);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 6px;
            border: 1px solid var(--border-color);
        }

        .signal-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--danger-color), var(--warning-color), var(--success-color));
            border-radius: 3px;
            transition: width 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .signal-text {
            font-size: 11px;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
        }

        /* Professional Satellite Info Panel */
        .satellite-info {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            background: var(--glass-bg);
            backdrop-filter: blur(40px);
            border-radius: 12px;
            padding: 14px;
            border: 1px solid var(--glass-border);
            max-width: 250px;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .satellite-info.visible {
            opacity: 1;
        }

        .sat-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .sat-details {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .sat-details strong {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Coordinates Display */
        .coordinates-display {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: var(--glass-bg);
            backdrop-filter: blur(40px);
            border-radius: 12px;
            padding: 14px;
            border: 1px solid var(--glass-border);
            min-width: 180px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .coordinates-display.collapsed {
            transform: translateY(-50%) translateX(85%);
            opacity: 0.8;
        }

        .coord-header {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
            text-align: center;
        }

        .coord-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 11px;
        }

        .coord-label {
            color: var(--text-muted);
        }

        .coord-value {
            color: var(--text-primary);
            font-weight: 500;
            font-variant-numeric: tabular-nums;
        }

        /* Toggle show/hide button - improved visibility */
        .toggle-show-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: var(--glass-bg);
            backdrop-filter: blur(40px);
            border: 2px solid var(--accent-color);
            border-radius: 50%;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            z-index: 30;
            transition: all 0.3s;
            display: none;
            pointer-events: all;
            box-shadow: 0 4px 20px rgba(0,102,204,0.3);
        }

        .toggle-show-btn.visible {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-show-btn:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 6px 25px rgba(0,102,204,0.4);
        }

        /* Loading Screen */
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--secondary-color);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 8px;
        }

        .loading-details {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Permission Steps */
        .permission-buttons {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            max-width: 350px;
        }

        .permission-step {
            text-align: center;
            width: 100%;
        }

        .step-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .step-description {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .btn {
            background: var(--accent-color);
            color: var(--text-primary);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            min-width: 180px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .btn:hover {
            background: #0052a3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,102,204,0.3);
        }

        .btn:disabled {
            background: var(--secondary-color);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.success {
            background: var(--success-color);
        }

        .btn.success:hover {
            background: #218838;
        }

        /* Error Dialog */
        .error-dialog {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass-bg);
            backdrop-filter: blur(40px);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            max-width: 300px;
            border: 1px solid var(--danger-color);
            box-shadow: 0 8px 32px rgba(220,53,69,0.3);
            z-index: 200;
        }

        .error-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--danger-color);
        }

        .error-message {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Mobile Responsive Design */
        @media (max-width: 480px) {
            .top-panel {
                top: env(safe-area-inset-top, 5px);
                left: 5px;
                right: 5px;
                padding: 12px;
            }

            .app-title {
                font-size: 14px;
            }

            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .status-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .alignment-panel {
                left: 5px;
                right: 110px;
                padding: 12px;
            }

            .compass-container {
                right: 5px;
                width: 80px;
                height: 80px;
            }

            .compass {
                font-size: 12px;
            }

            .compass-needle {
                height: 25px;
                top: 15px;
            }

            .satellite-info {
                left: 5px;
                max-width: 200px;
                padding: 12px;
            }

            .coordinates-display {
                right: 5px;
                min-width: 150px;
                padding: 12px;
            }

            .metric-value {
                font-size: 16px;
            }

            .status-value {
                font-size: 12px;
            }
        }

        @media (max-width: 360px) {
            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 4px;
            }

            .metric-card {
                padding: 8px 4px;
                min-width: 80px;
            }

            .metric-value {
                font-size: 14px;
            }

            .metric-label {
                font-size: 9px;
            }

            .status-card {
                padding: 8px;
                min-width: 100px;
            }

            .app-title {
                font-size: 12px;
            }

            .compass-container {
                width: 70px;
                height: 70px;
            }

            .alignment-panel {
                right: 85px;
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            :root {
                --border-color: rgba(255,255,255,0.3);
                --glass-border: rgba(255,255,255,0.2);
            }
        }
    </style>
</head>
<body class="rtl">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text" data-key="loading.title">جاري تهيئة النظام</div>
        <div id="loadingDetails" class="loading-details" data-key="loading.details">بدء التشغيل...</div>
        
        <div id="permissionButtons" class="permission-buttons" style="display: none;">
            <div class="permission-step">
                <div class="step-title" data-key="permissions.camera.title">صلاحية الكاميرا مطلوبة</div>
                <div class="step-description" data-key="permissions.camera.description">نحتاج للكاميرا لعرض الاتجاه الحقيقي للسماء</div>
                <button class="btn" id="cameraBtn" onclick="requestCameraPermission()">
                    <span data-key="permissions.camera.button">منح صلاحية الكاميرا</span>
                </button>
            </div>

            <div class="permission-step">
                <div class="step-title" data-key="permissions.location.title">صلاحية الموقع مطلوبة</div>
                <div class="step-description" data-key="permissions.location.description">نحتاج موقعك لحساب اتجاه الأقمار الصناعية بدقة</div>
                <button class="btn" id="locationBtn" onclick="requestLocationPermission()" disabled>
                    <span data-key="permissions.location.button">منح صلاحية الموقع</span>
                </button>
            </div>

            <div class="permission-step">
                <div class="step-title" data-key="permissions.sensors.title">صلاحية أجهزة الاستشعار مطلوبة</div>
                <div class="step-description" data-key="permissions.sensors.description">نحتاج البوصلة ومقياس الإمالة لتحديد اتجاه الجهاز</div>
                <button class="btn" id="orientationBtn" onclick="requestOrientationPermission()" disabled>
                    <span data-key="permissions.sensors.button">منح صلاحية الاستشعار</span>
                </button>
            </div>

            <div class="permission-step" id="startStep" style="display: none;">
                <div class="step-title" data-key="permissions.complete.title">تم منح جميع الصلاحيات</div>
                <div class="step-description" data-key="permissions.complete.description">يمكنك الآن استخدام التطبيق بكامل إمكانياته</div>
                <button class="btn success" onclick="finishSetup()">
                    <span data-key="permissions.complete.button">تشغيل التطبيق</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Video Background -->
    <video id="video" autoplay playsinline muted></video>
    
    <!-- AR Overlay -->
    <div class="overlay">
        <div class="crosshair">
            <div class="crosshair-circle">
                <div class="crosshair-lines">
                    <div class="crosshair-h"></div>
                    <div class="crosshair-v"></div>
                </div>
            </div>
        </div>
        <div id="satelliteMarkers"></div>
    </div>

    <!-- Toggle Show Button (appears when panels are hidden) -->
    <button class="toggle-show-btn" id="toggleShowBtn" onclick="showPanels()">
        ▲
    </button>

    <!-- HUD Interface -->
    <div class="hud-overlay">
        <!-- Top Control Panel -->
        <div class="top-panel" id="topPanel">
            <div class="panel-header">
                <div class="app-title">SatAlign Pro Enterprise</div>
                <div class="toggle-controls">
                    <div class="language-toggle">
                        <button class="lang-btn active" onclick="switchLanguage('ar')">AR</button>
                        <button class="lang-btn" onclick="switchLanguage('en')">EN</button>
                    </div>
                    <button class="control-btn" id="togglePanels" onclick="togglePanels()" title="إخفاء/إظهار الواجهة">
                        <span>▼</span>
                    </button>
                </div>
            </div>
            
            <div class="satellite-selector">
                <div class="selector-label" data-key="interface.satellite.label">اختيار القمر الصناعي</div>
                <select id="satelliteSelect">
                    <!-- سيتم ملؤها بواسطة JavaScript -->
                </select>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label" data-key="metrics.azimuth">الاتجاه</div>
                    <div class="metric-value" id="azimuth">--°</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label" data-key="metrics.elevation">الارتفاع</div>
                    <div class="metric-value" id="elevation">--°</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label" data-key="metrics.skew">انحراف LNB</div>
                    <div class="metric-value" id="skew">--°</div>
                </div>
            </div>
            
            <div class="status-grid">
                <div class="status-card">
                    <div class="status-label" data-key="status.compass">بوصلة الجهاز</div>
                    <div class="status-value" id="deviceHeading">--°</div>
                </div>
                <div class="status-card">
                    <div class="status-label" data-key="status.tilt">إمالة الجهاز</div>
                    <div class="status-value" id="deviceTilt">--°</div>
                </div>
                <div class="status-card">
                    <div class="status-label" data-key="status.accuracy">دقة GPS</div>
                    <div class="status-value" id="gpsAccuracy">--m</div>
                </div>
                <div class="status-card">
                    <div class="status-label" data-key="status.declination">الانحراف المغناطيسي</div>
                    <div class="status-value" id="magneticDeclination">--°</div>
                </div>
            </div>
        </div>

        <!-- Professional Compass -->
        <div class="compass-container" id="compassContainer">
            <div class="compass">
                <div class="compass-markings">
                    <!-- Compass markings will be generated by JS -->
                </div>
                <div class="compass-needle" id="compassNeedle"></div>
                <div id="compassDirection">N</div>
            </div>
        </div>

        <!-- Alignment Status Panel -->
        <div class="alignment-panel" id="alignmentPanel">
            <div class="alignment-status" id="alignmentStatus" data-key="status.searching">البحث عن القمر الصناعي</div>
            <div class="alignment-details" id="alignmentDetails" data-key="status.instructions">اختر قمر صناعي من الأعلى للبدء</div>
            <div class="signal-strength">
                <div class="signal-bar" id="signalBar" style="width: 0%"></div>
            </div>
            <div class="signal-text" id="signalText" data-key="status.precision">دقة التوجيه: 0%</div>
        </div>

        <!-- Satellite Information Panel -->
        <div class="satellite-info" id="satelliteInfo">
            <div class="sat-name" id="satName"></div>
            <div class="sat-details" id="satDetails"></div>
        </div>

        <!-- Coordinates Display -->
        <div class="coordinates-display" id="coordinatesDisplay">
            <div class="coord-header" data-key="coordinates.title">إحداثيات الهدف</div>
            <div class="coord-item">
                <span class="coord-label" data-key="coordinates.latitude">خط العرض:</span>
                <span class="coord-value" id="coordLat">--</span>
            </div>
            <div class="coord-item">
                <span class="coord-label" data-key="coordinates.longitude">خط الطول:</span>
                <span class="coord-value" id="coordLon">--</span>
            </div>
            <div class="coord-item">
                <span class="coord-label" data-key="coordinates.altitude">الارتفاع:</span>
                <span class="coord-value" id="coordAlt">35,786 km</span>
            </div>
            <div class="coord-item">
                <span class="coord-label" data-key="coordinates.distance">المسافة:</span>
                <span class="coord-value" id="coordDistance">-- km</span>
            </div>
        </div>
    </div>

    <script>
        // Professional Multilingual System
        const translations = {
            en: {
                loading: {
                    title: "Initializing System",
                    details: "Starting up..."
                },
                permissions: {
                    camera: {
                        title: "Camera Access Required",
                        description: "We need camera access to display the real sky view",
                        button: "Grant Camera Access"
                    },
                    location: {
                        title: "Location Access Required", 
                        description: "We need your location to calculate satellite positions accurately",
                        button: "Grant Location Access"
                    },
                    sensors: {
                        title: "Device Sensors Required",
                        description: "We need compass and orientation sensors to detect device direction",
                        button: "Grant Sensor Access"
                    },
                    complete: {
                        title: "All Permissions Granted",
                        description: "You can now use the application with full capabilities",
                        button: "Launch Application"
                    }
                },
                interface: {
                    satellite: {
                        label: "Satellite Selection",
                        placeholder: "-- Select Satellite --"
                    }
                },
                satellites: {
                    arab: "Arab Satellites",
                    european: "European Satellites",
                    other: "Other Satellites"
                },
                metrics: {
                    azimuth: "Azimuth",
                    elevation: "Elevation", 
                    skew: "LNB Skew"
                },
                status: {
                    compass: "Device Heading",
                    tilt: "Device Tilt",
                    accuracy: "GPS Accuracy",
                    declination: "Magnetic Decl.",
                    searching: "Searching for Satellite",
                    instructions: "Select a satellite from above to begin",
                    precision: "Alignment Precision: 0%",
                    perfect: "Perfect Alignment Achieved",
                    excellent: "Excellent Alignment",
                    good: "Good Alignment", 
                    fair: "Fair Alignment",
                    poor: "Poor Alignment",
                    none: "No Alignment"
                },
                coordinates: {
                    title: "Target Coordinates",
                    latitude: "Latitude:",
                    longitude: "Longitude:",
                    altitude: "Altitude:",
                    distance: "Distance:"
                },
                alignment: {
                    turnRight: "Turn right",
                    turnLeft: "Turn left",
                    tiltUp: "Tilt up",
                    tiltDown: "Tilt down",
                    degrees: "degrees",
                    perfect: "Dish is perfectly aligned with satellite",
                    distance: "Distance"
                }
            },
            ar: {
                loading: {
                    title: "جاري تهيئة النظام",
                    details: "بدء التشغيل..."
                },
                permissions: {
                    camera: {
                        title: "صلاحية الكاميرا مطلوبة",
                        description: "نحتاج للكاميرا لعرض الاتجاه الحقيقي للسماء",
                        button: "منح صلاحية الكاميرا"
                    },
                    location: {
                        title: "صلاحية الموقع مطلوبة",
                        description: "نحتاج موقعك لحساب اتجاه الأقمار الصناعية بدقة",
                        button: "منح صلاحية الموقع"
                    },
                    sensors: {
                        title: "صلاحية أجهزة الاستشعار مطلوبة",
                        description: "نحتاج البوصلة ومقياس الإمالة لتحديد اتجاه الجهاز",
                        button: "منح صلاحية الاستشعار"
                    },
                    complete: {
                        title: "تم منح جميع الصلاحيات",
                        description: "يمكنك الآن استخدام التطبيق بكامل إمكانياته",
                        button: "تشغيل التطبيق"
                    }
                },
                interface: {
                    satellite: {
                        label: "اختيار القمر الصناعي",
                        placeholder: "-- اختر القمر الصناعي --"
                    }
                },
                satellites: {
                    arab: "الأقمار العربية",
                    european: "الأقمار الأوروبية", 
                    other: "أقمار أخرى"
                },
                metrics: {
                    azimuth: "الاتجاه",
                    elevation: "الارتفاع",
                    skew: "انحراف LNB"
                },
                status: {
                    compass: "بوصلة الجهاز",
                    tilt: "إمالة الجهاز",
                    accuracy: "دقة GPS",
                    declination: "الانحراف المغناطيسي",
                    searching: "البحث عن القمر الصناعي",
                    instructions: "اختر قمر صناعي من الأعلى للبدء",
                    precision: "دقة التوجيه: 0%",
                    perfect: "توجيه مثالي محقق",
                    excellent: "توجيه ممتاز",
                    good: "توجيه جيد",
                    fair: "توجيه متوسط", 
                    poor: "توجيه ضعيف",
                    none: "لا يوجد توجيه"
                },
                coordinates: {
                    title: "إحداثيات الهدف",
                    latitude: "خط العرض:",
                    longitude: "خط الطول:",
                    altitude: "الارتفاع:",
                    distance: "المسافة:"
                },
                alignment: {
                    turnRight: "استدر يميناً",
                    turnLeft: "استدر يساراً", 
                    tiltUp: "اتجه للأعلى",
                    tiltDown: "اتجه للأسفل",
                    degrees: "درجة",
                    perfect: "الطبق موجه بشكل مثالي نحو القمر الصناعي",
                    distance: "المسافة"
                }
            }
        };

        // Global variables
        let satApp = null;
        let currentLanguage = 'ar';
        let panelsCollapsed = false;

        // Professional Permission Functions
        async function requestCameraPermission() {
            const btn = document.getElementById('cameraBtn');
            const locationBtn = document.getElementById('locationBtn');
            
            try {
                btn.textContent = 'جاري المعالجة...';
                btn.disabled = true;

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                stream.getTracks().forEach(track => track.stop());
                
                btn.textContent = '✓ تم منح صلاحية الكاميرا';
                btn.classList.add('success');
                satApp.cameraPermission = true;
                
                locationBtn.disabled = false;
                
            } catch (error) {
                btn.textContent = '✗ فشل منح صلاحية الكاميرا';
                btn.style.background = 'var(--danger-color)';
                
                setTimeout(() => {
                    btn.textContent = 'إعادة المحاولة';
                    btn.style.background = 'var(--accent-color)';
                    btn.disabled = false;
                }, 3000);
            }
        }

        async function requestLocationPermission() {
            const btn = document.getElementById('locationBtn');
            const orientationBtn = document.getElementById('orientationBtn');
            
            try {
                btn.textContent = 'جاري المعالجة...';
                btn.disabled = true;

                await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            satApp.userLat = position.coords.latitude;
                            satApp.userLon = position.coords.longitude;
                            satApp.gpsAccuracy = Math.round(position.coords.accuracy);
                            resolve();
                        },
                        (error) => reject(error),
                        { enableHighAccuracy: true, timeout: 15000 }
                    );
                });
                
                btn.textContent = '✓ تم منح صلاحية الموقع';
                btn.classList.add('success');
                satApp.locationPermission = true;
                
                orientationBtn.disabled = false;
                
            } catch (error) {
                btn.textContent = '✗ فشل منح صلاحية الموقع';
                btn.style.background = 'var(--danger-color)';
                
                setTimeout(() => {
                    btn.textContent = 'إعادة المحاولة';
                    btn.style.background = 'var(--accent-color)';
                    btn.disabled = false;
                }, 3000);
            }
        }

        async function requestOrientationPermission() {
            const btn = document.getElementById('orientationBtn');
            const startStep = document.getElementById('startStep');
            
            try {
                btn.textContent = 'جاري المعالجة...';
                btn.disabled = true;

                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') {
                        throw new Error('Permission denied');
                    }
                }
                
                btn.textContent = '✓ تم منح صلاحية الاستشعار';
                btn.classList.add('success');
                satApp.orientationPermission = true;
                
                startStep.style.display = 'block';
                
            } catch (error) {
                btn.textContent = '✗ فشل منح صلاحية الاستشعار';
                btn.style.background = 'var(--danger-color)';
                
                setTimeout(() => {
                    btn.textContent = 'إعادة المحاولة';
                    btn.style.background = 'var(--accent-color)';
                    btn.disabled = false;
                }, 3000);
            }
        }

        async function finishSetup() {
            const loadingScreen = document.getElementById('loadingScreen');
            const loadingDetails = document.getElementById('loadingDetails');
            
            try {
                loadingDetails.textContent = 'حساب الانحراف المغناطيسي...';
                await satApp.calculateMagneticDeclination();
                
                loadingDetails.textContent = 'تهيئة الكاميرا...';
                await satApp.getUserMedia();
                
                loadingDetails.textContent = 'تهيئة أجهزة الاستشعار...';
                await satApp.setupSensors();
                
                loadingDetails.textContent = 'تحميل الواجهة...';
                satApp.setupEventListeners();
                satApp.populateSatelliteList();
                
                loadingDetails.textContent = 'مكتمل!';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    satApp.startUpdates();
                }, 500);
                
            } catch (error) {
                satApp.showError('خطأ في التهيئة', error.message);
            }
        }

        // Professional Translation System
        function t(key, defaultValue = '') {
            const keys = key.split('.');
            let value = translations[currentLanguage];
            
            for (const k of keys) {
                value = value?.[k];
            }
            
            return value || defaultValue;
        }

        function updateTranslations() {
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.getAttribute('data-key');
                const translation = t(key);
                if (translation) {
                    element.textContent = translation;
                }
            });
        }

        function switchLanguage(lang) {
            currentLanguage = lang;
            
            // Update active language button
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update body direction
            document.body.className = lang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = lang;
            
            // Update all translations
            updateTranslations();
            
            // Re-populate satellite list
            if (satApp?.satellites) {
                satApp.populateSatelliteList();
            }
            
            // Update satellite info if visible
            if (satApp?.selectedSatellite) {
                satApp.updateSatelliteInfo();
            }
        }

        // Enhanced Interface Controls
        function togglePanels() {
            panelsCollapsed = !panelsCollapsed;
            const topPanel = document.getElementById('topPanel');
            const alignmentPanel = document.getElementById('alignmentPanel');
            const coordDisplay = document.getElementById('coordinatesDisplay');
            const compassContainer = document.getElementById('compassContainer');
            const satelliteInfo = document.getElementById('satelliteInfo');
            const toggleShowBtn = document.getElementById('toggleShowBtn');
            
            if (panelsCollapsed) {
                topPanel.classList.add('collapsed');
                alignmentPanel.classList.add('collapsed');
                coordDisplay.classList.add('collapsed');
                compassContainer.style.opacity = '0.3';
                satelliteInfo.style.opacity = '0.3';
                toggleShowBtn.classList.add('visible');
            } else {
                topPanel.classList.remove('collapsed');
                alignmentPanel.classList.remove('collapsed');
                coordDisplay.classList.remove('collapsed');
                compassContainer.style.opacity = '1';
                satelliteInfo.style.opacity = '1';
                toggleShowBtn.classList.remove('visible');
            }
        }

        function showPanels() {
            panelsCollapsed = false;
            const topPanel = document.getElementById('topPanel');
            const alignmentPanel = document.getElementById('alignmentPanel');
            const coordDisplay = document.getElementById('coordinatesDisplay');
            const compassContainer = document.getElementById('compassContainer');
            const satelliteInfo = document.getElementById('satelliteInfo');
            const toggleShowBtn = document.getElementById('toggleShowBtn');
            
            topPanel.classList.remove('collapsed');
            alignmentPanel.classList.remove('collapsed');
            coordDisplay.classList.remove('collapsed');
            compassContainer.style.opacity = '1';
            satelliteInfo.style.opacity = '1';
            toggleShowBtn.classList.remove('visible');
            
            // Update toggle button state
            const toggleBtn = document.getElementById('togglePanels');
            toggleBtn.innerHTML = '<span>▼</span>';
        }

        // Professional Satellite Application Class
        class ProfessionalSatelliteFinder {
            constructor() {
                this.initializeElements();
                this.initializeData();
                this.initializeState();
                this.startInitialization();
            }

            initializeElements() {
                this.video = document.getElementById('video');
                this.satelliteSelect = document.getElementById('satelliteSelect');
                this.loadingScreen = document.getElementById('loadingScreen');
                this.loadingDetails = document.getElementById('loadingDetails');
                this.permissionButtons = document.getElementById('permissionButtons');
                this.markersContainer = document.getElementById('satelliteMarkers');
                this.satelliteInfo = document.getElementById('satelliteInfo');
            }

            initializeData() {
                this.satellites = {
                    'nilesat-201': {
                        name: { en: 'Nilesat 201', ar: 'نايل سات 201' },
                        longitude: -7.0,
                        description: { 
                            en: 'Primary satellite for Middle East and North Africa',
                            ar: 'القمر الرئيسي للشرق الأوسط وشمال أفريقيا'
                        },
                        frequencies: ['11747 H', '11766 V', '11785 H', '11804 V'],
                        footprint: { en: 'MENA', ar: 'الشرق الأوسط وشمال أفريقيا' },
                        power: '8.5 kW',
                        operator: { en: 'Egyptian Satellite Company', ar: 'الشركة المصرية للأقمار الصناعية' }
                    },
                    'nilesat-301': {
                        name: { en: 'Nilesat 301', ar: 'نايل سات 301' },
                        longitude: -7.0,
                        description: { 
                            en: 'Latest Nilesat with advanced technology',
                            ar: 'أحدث أقمار نايل سات بتقنية متقدمة'
                        },
                        frequencies: ['11823 H', '11842 V', '11861 H', '11880 V'],
                        footprint: { en: 'MENA', ar: 'الشرق الأوسط وشمال أفريقيا' },
                        power: '12 kW',
                        operator: { en: 'Egyptian Satellite Company', ar: 'الشركة المصرية للأقمار الصناعية' }
                    },
                    'arabsat-5a': {
                        name: { en: 'Arabsat 5A', ar: 'عربسات 5A' },
                        longitude: 30.5,
                        description: { 
                            en: 'Covers Middle East and North Africa',
                            ar: 'يغطي الشرق الأوسط وشمال أفريقيا'
                        },
                        frequencies: ['11996 V', '12015 H', '12034 V', '12053 H'],
                        footprint: { en: 'MENA + Europe', ar: 'الشرق الأوسط وأوروبا' },
                        power: '10.5 kW',
                        operator: { en: 'Arabsat', ar: 'عربسات' }
                    },
                    'arabsat-5c': {
                        name: { en: 'Arabsat 5C', ar: 'عربسات 5C' },
                        longitude: 20.0,
                        description: { 
                            en: 'Premium quality services for Arab region',
                            ar: 'خدمات فائقة الجودة للمنطقة العربية'
                        },
                        frequencies: ['11900 V', '11919 H', '11938 V', '11957 H'],
                        footprint: { en: 'MENA', ar: 'الشرق الأوسط وشمال أفريقيا' },
                        power: '9.8 kW',
                        operator: { en: 'Arabsat', ar: 'عربسات' }
                    },
                    'badr-4': {
                        name: { en: 'Badr 4', ar: 'بدر 4' },
                        longitude: 26.0,
                        description: { 
                            en: 'Advanced Arab communications satellite',
                            ar: 'قمر عربي متقدم للاتصالات'
                        },
                        frequencies: ['11996 V', '12015 H', '12034 V'],
                        footprint: { en: 'MENA + South Asia', ar: 'الشرق الأوسط وجنوب آسيا' },
                        power: '8.2 kW',
                        operator: { en: 'Arabsat', ar: 'عربسات' }
                    },
                    'badr-5': {
                        name: { en: 'Badr 5', ar: 'بدر 5' },
                        longitude: 26.0,
                        description: { 
                            en: 'Advanced upgrade to Badr network',
                            ar: 'تحديث متقدم لشبكة بدر'
                        },
                        frequencies: ['12053 H', '12072 V', '12091 H'],
                        footprint: { en: 'MENA + South Asia', ar: 'الشرق الأوسط وجنوب آسيا' },
                        power: '9.5 kW',
                        operator: { en: 'Arabsat', ar: 'عربسات' }
                    },
                    'badr-6': {
                        name: { en: 'Badr 6', ar: 'بدر 6' },
                        longitude: 26.0,
                        description: { 
                            en: 'Latest generation Badr satellite',
                            ar: 'أحدث جيل من أقمار بدر'
                        },
                        frequencies: ['12110 V', '12129 H', '12148 V'],
                        footprint: { en: 'MENA + South Asia', ar: 'الشرق الأوسط وجنوب آسيا' },
                        power: '11.2 kW',
                        operator: { en: 'Arabsat', ar: 'عربسات' }
                    },
                    'badr-7': {
                        name: { en: 'Badr 7', ar: 'بدر 7' },
                        longitude: 26.0,
                        description: { 
                            en: 'Ultra-modern technology',
                            ar: 'تقنية فائقة الحداثة'
                        },
                        frequencies: ['12167 H', '12186 V', '12205 H'],
                        footprint: { en: 'MENA + South Asia', ar: 'الشرق الأوسط وجنوب آسيا' },
                        power: '12.5 kW',
                        operator: { en: 'Arabsat', ar: 'عربسات' }
                    },
                    'badr-8': {
                        name: { en: 'Badr 8', ar: 'بدر 8' },
                        longitude: 26.0,
                        description: { 
                            en: 'Latest addition to Badr fleet',
                            ar: 'أحدث إضافة لأسطول بدر'
                        },
                        frequencies: ['12224 V', '12243 H', '12262 V'],
                        footprint: { en: 'MENA + South Asia', ar: 'الشرق الأوسط وجنوب آسيا' },
                        power: '13.8 kW',
                        operator: { en: 'Arabsat', ar: 'عربسات' }
                    },
                    'hotbird-13f': {
                        name: { en: 'Hotbird 13F', ar: 'هوت بيرد 13F' },
                        longitude: 13.0,
                        description: { 
                            en: 'Primary European satellite',
                            ar: 'القمر الأوروبي الرئيسي'
                        },
                        frequencies: ['10723 H', '10742 V', '10761 H', '10780 V'],
                        footprint: { en: 'Europe + North Africa', ar: 'أوروبا وشمال أفريقيا' },
                        power: '15.2 kW',
                        operator: { en: 'Eutelsat', ar: 'يوتلسات' }
                    },
                    'hotbird-13g': {
                        name: { en: 'Hotbird 13G', ar: 'هوت بيرد 13G' },
                        longitude: 13.0,
                        description: { 
                            en: 'New Hotbird upgrade',
                            ar: 'تحديث جديد لهوت بيرد'
                        },
                        frequencies: ['10799 H', '10818 V', '10837 H', '10856 V'],
                        footprint: { en: 'Europe + North Africa', ar: 'أوروبا وشمال أفريقيا' },
                        power: '16.1 kW',
                        operator: { en: 'Eutelsat', ar: 'يوتلسات' }
                    },
                    'astra-1kr': {
                        name: { en: 'Astra 1KR', ar: 'أسترا 1KR' },
                        longitude: 19.2,
                        description: { 
                            en: 'Advanced European satellite',
                            ar: 'قمر أوروبي متقدم'
                        },
                        frequencies: ['10714 H', '10744 V', '10773 H', '10803 V'],
                        footprint: { en: 'Europe', ar: 'أوروبا' },
                        power: '14.8 kW',
                        operator: { en: 'SES', ar: 'إس إي إس' }
                    },
                    'astra-1l': {
                        name: { en: 'Astra 1L', ar: 'أسترا 1L' },
                        longitude: 19.2,
                        description: { 
                            en: 'Modern Astra satellite',
                            ar: 'أسترا الحديث'
                        },
                        frequencies: ['10832 H', '10862 V', '10891 H', '10920 V'],
                        footprint: { en: 'Europe', ar: 'أوروبا' },
                        power: '15.5 kW',
                        operator: { en: 'SES', ar: 'إس إي إس' }
                    },
                    'astra-1m': {
                        name: { en: 'Astra 1M', ar: 'أسترا 1M' },
                        longitude: 19.2,
                        description: { 
                            en: 'Advanced Astra development',
                            ar: 'تطوير متقدم لأسترا'
                        },
                        frequencies: ['10949 V', '10979 H', '11008 V', '11038 H'],
                        footprint: { en: 'Europe', ar: 'أوروبا' },
                        power: '16.2 kW',
                        operator: { en: 'SES', ar: 'إس إي إس' }
                    },
                    'astra-1n': {
                        name: { en: 'Astra 1N', ar: 'أسترا 1N' },
                        longitude: 19.2,
                        description: { 
                            en: 'Latest Astra satellite',
                            ar: 'أحدث أقمار أسترا'
                        },
                        frequencies: ['11068 V', '11097 H', '11127 V', '11156 H'],
                        footprint: { en: 'Europe', ar: 'أوروبا' },
                        power: '17.1 kW',
                        operator: { en: 'SES', ar: 'إس إي إس' }
                    },
                    'eutelsat-16a': {
                        name: { en: 'Eutelsat 16A', ar: 'يوتلسات 16A' },
                        longitude: 16.0,
                        description: { 
                            en: 'Comprehensive European satellite',
                            ar: 'قمر أوروبي شامل'
                        },
                        frequencies: ['11595 H', '11623 V', '11652 H', '11680 V'],
                        footprint: { en: 'Europe + Africa', ar: 'أوروبا وأفريقيا' },
                        power: '13.5 kW',
                        operator: { en: 'Eutelsat', ar: 'يوتلسات' }
                    },
                    'eutelsat-7c': {
                        name: { en: 'Eutelsat 7C', ar: 'يوتلسات 7C' },
                        longitude: 7.0,
                        description: { 
                            en: 'European and African coverage',
                            ar: 'تغطية أوروبية وأفريقية'
                        },
                        frequencies: ['11304 H', '11332 V', '11360 H', '11389 V'],
                        footprint: { en: 'Europe + Africa', ar: 'أوروبا وأفريقيا' },
                        power: '12.8 kW',
                        operator: { en: 'Eutelsat', ar: 'يوتلسات' }
                    },
                    'turksat-4a': {
                        name: { en: 'Turksat 4A', ar: 'تورك سات 4A' },
                        longitude: 42.0,
                        description: { 
                            en: 'Primary Turkish satellite',
                            ar: 'القمر التركي الرئيسي'
                        },
                        frequencies: ['11957 V', '11975 H', '12034 V', '12053 H'],
                        footprint: { en: 'Turkey + Europe + MENA', ar: 'تركيا وأوروبا والشرق الأوسط' },
                        power: '11.8 kW',
                        operator: { en: 'Turksat', ar: 'تورك سات' }
                    },
                    'turksat-4b': {
                        name: { en: 'Turksat 4B', ar: 'تورك سات 4B' },
                        longitude: 42.0,
                        description: { 
                            en: 'Turksat upgrade',
                            ar: 'تحديث تورك سات'
                        },
                        frequencies: ['12072 V', '12091 H', '12110 V', '12129 H'],
                        footprint: { en: 'Turkey + Europe + MENA', ar: 'تركيا وأوروبا والشرق الأوسط' },
                        power: '12.5 kW',
                        operator: { en: 'Turksat', ar: 'تورك سات' }
                    },
                    'hispasat-30w-6': {
                        name: { en: 'Hispasat 30W-6', ar: 'هيسباسات 30W-6' },
                        longitude: -30.0,
                        description: { 
                            en: 'Advanced Atlantic satellite',
                            ar: 'قمر أطلسي متقدم'
                        },
                        frequencies: ['11876 H', '11934 V', '11992 H', '12051 V'],
                        footprint: { en: 'Americas + Europe', ar: 'الأمريكتان وأوروبا' },
                        power: '14.2 kW',
                        operator: { en: 'Hispasat', ar: 'هيسباسات' }
                    },
                    'intelsat-33e': {
                        name: { en: 'Intelsat 33e', ar: 'إنتلسات 33e' },
                        longitude: 60.0,
                        description: { 
                            en: 'Advanced Asian satellite',
                            ar: 'قمر آسيوي متطور'
                        },
                        frequencies: ['11135 H', '11175 V', '11215 H', '11255 V'],
                        footprint: { en: 'Asia + MENA', ar: 'آسيا والشرق الأوسط' },
                        power: '16.8 kW',
                        operator: { en: 'Intelsat', ar: 'إنتلسات' }
                    },
                    'amos-17': {
                        name: { en: 'Amos 17', ar: 'عاموس 17' },
                        longitude: 17.0,
                        description: { 
                            en: 'Modern Israeli satellite',
                            ar: 'قمر إسرائيلي حديث'
                        },
                        frequencies: ['10843 V', '10883 H', '10923 V', '10963 H'],
                        footprint: { en: 'Europe + Africa', ar: 'أوروبا وأفريقيا' },
                        power: '10.5 kW',
                        operator: { en: 'Spacecom', ar: 'سبيس كوم' }
                    }
                };
            }

            initializeState() {
                this.userLat = null;
                this.userLon = null;
                this.deviceHeading = 0;
                this.deviceTilt = 0;
                this.deviceRoll = 0;
                this.selectedSatellite = null;
                this.magneticDeclination = 0;
                this.gpsAccuracy = 0;
                this.calibrated = false;
                this.orientationPermission = false;
                this.cameraPermission = false;
                this.locationPermission = false;
                this.updateInterval = null;
            }

            // Enhanced satellite list population
            populateSatelliteList() {
                const select = this.satelliteSelect;
                select.innerHTML = '';
                
                // Add placeholder option
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = t('interface.satellite.placeholder', '-- اختر القمر الصناعي --');
                select.appendChild(placeholder);

                // Group satellites
                const groups = {
                    arab: [],
                    european: [],
                    other: []
                };

                for (const [key, satellite] of Object.entries(this.satellites)) {
                    const item = { key, satellite };
                    
                    if (['nilesat-201', 'nilesat-301', 'arabsat-5a', 'arabsat-5c', 'badr-4', 'badr-5', 'badr-6', 'badr-7', 'badr-8'].includes(key)) {
                        groups.arab.push(item);
                    } else if (['hotbird-13f', 'hotbird-13g', 'astra-1kr', 'astra-1l', 'astra-1m', 'astra-1n', 'eutelsat-16a', 'eutelsat-7c'].includes(key)) {
                        groups.european.push(item);
                    } else {
                        groups.other.push(item);
                    }
                }

                // Add Arab satellites group
                if (groups.arab.length > 0) {
                    const arabGroup = document.createElement('optgroup');
                    arabGroup.label = t('satellites.arab', 'الأقمار العربية');
                    groups.arab.forEach(({ key, satellite }) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${satellite.name[currentLanguage] || satellite.name.en} (${satellite.longitude}°${satellite.longitude >= 0 ? 'E' : 'W'})`;
                        arabGroup.appendChild(option);
                    });
                    select.appendChild(arabGroup);
                }

                // Add European satellites group
                if (groups.european.length > 0) {
                    const europeanGroup = document.createElement('optgroup');
                    europeanGroup.label = t('satellites.european', 'الأقمار الأوروبية');
                    groups.european.forEach(({ key, satellite }) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${satellite.name[currentLanguage] || satellite.name.en} (${satellite.longitude}°${satellite.longitude >= 0 ? 'E' : 'W'})`;
                        europeanGroup.appendChild(option);
                    });
                    select.appendChild(europeanGroup);
                }

                // Add other satellites group
                if (groups.other.length > 0) {
                    const otherGroup = document.createElement('optgroup');
                    otherGroup.label = t('satellites.other', 'أقمار أخرى');
                    groups.other.forEach(({ key, satellite }) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${satellite.name[currentLanguage] || satellite.name.en} (${satellite.longitude}°${satellite.longitude >= 0 ? 'E' : 'W'})`;
                        otherGroup.appendChild(option);
                    });
                    select.appendChild(otherGroup);
                }
            }

            async startInitialization() {
                try {
                    this.updateLoadingText('فحص الصلاحيات...');
                    await this.checkPermissions();
                    
                    if (this.cameraPermission && this.locationPermission && this.orientationPermission) {
                        await this.continueSetup();
                    }
                    
                } catch (error) {
                    this.showError('خطأ في التهيئة', error.message);
                }
            }

            async continueSetup() {
                this.updateLoadingText('حساب الانحراف المغناطيسي...');
                await this.calculateMagneticDeclination();
                
                this.updateLoadingText('تهيئة الكاميرا...');
                await this.setupCamera();
                
                this.updateLoadingText('تهيئة أجهزة الاستشعار...');
                await this.setupSensors();
                
                this.updateLoadingText('تحميل الواجهة...');
                this.setupEventListeners();
                this.generateCompassMarkings();
                this.populateSatelliteList();
                
                this.updateLoadingText('مكتمل!');
                setTimeout(() => {
                    this.loadingScreen.style.display = 'none';
                    this.startUpdates();
                }, 500);
            }

            updateLoadingText(text) {
                this.loadingDetails.textContent = text;
            }

            async checkPermissions() {
                if (this.isIOS()) {
                    this.permissionButtons.style.display = 'block';
                    this.updateLoadingText('يرجى منح الصلاحيات المطلوبة لتشغيل التطبيق');
                    return;
                }

                try {
                    await this.requestAllPermissions();
                } catch (error) {
                    this.permissionButtons.style.display = 'block';
                    this.updateLoadingText('يرجى منح الصلاحيات المطلوبة');
                }
            }

            isIOS() {
                return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                       (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            }

            async requestAllPermissions() {
                await this.getUserMedia();
                this.cameraPermission = true;

                await this.getUserLocation();
                this.locationPermission = true;

                this.orientationPermission = true;
            }

            async getUserLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('خدمة تحديد الموقع غير متوفرة'));
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            this.userLat = position.coords.latitude;
                            this.userLon = position.coords.longitude;
                            this.gpsAccuracy = Math.round(position.coords.accuracy);
                            document.getElementById('gpsAccuracy').textContent = this.gpsAccuracy + 'm';
                            
                            // Update coordinates display
                            document.getElementById('coordLat').textContent = this.userLat.toFixed(6) + '°';
                            document.getElementById('coordLon').textContent = this.userLon.toFixed(6) + '°';
                            
                            resolve();
                        },
                        (error) => {
                            let message = 'فشل في تحديد الموقع';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    message = 'تم رفض صلاحية الموقع';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    message = 'الموقع غير متوفر';
                                    break;
                                case error.TIMEOUT:
                                    message = 'انتهت مهلة تحديد الموقع';
                                    break;
                            }
                            reject(new Error(message));
                        },
                        { 
                            enableHighAccuracy: true, 
                            timeout: 15000, 
                            maximumAge: 300000 
                        }
                    );
                });
            }

            async calculateMagneticDeclination() {
                const lat = this.userLat;
                const lon = this.userLon;
                
                // Enhanced magnetic declination calculation
                const year = new Date().getFullYear();
                
                // Calculate day of year correctly
                const now = new Date();
                const start = new Date(now.getFullYear(), 0, 0);
                const diff = (now - start) + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);
                const dayOfYear = Math.floor(diff / (1000 * 60 * 60 * 24));
                const decimalYear = year + (dayOfYear - 1) / 365;
                
                // Professional IGRF-13 simplified model
                const latRad = lat * Math.PI / 180;
                const lonRad = lon * Math.PI / 180;
                
                // Enhanced calculation using multiple harmonic terms
                const term1 = Math.sin(latRad) * Math.cos(lonRad) * 12.5;
                const term2 = Math.cos(latRad) * Math.sin(lonRad) * 8.3;
                const term3 = Math.sin(2 * latRad) * 3.2;
                const term4 = Math.cos(2 * lonRad) * 1.8;
                
                // Secular variation (annual change)
                const secularVariation = (decimalYear - 2020) * 0.05;
                
                this.magneticDeclination = term1 + term2 + term3 + term4 + secularVariation;
                this.magneticDeclination = Math.round(this.magneticDeclination * 10) / 10;
                
                // Ensure reasonable bounds (-30° to +30°)
                this.magneticDeclination = Math.max(-30, Math.min(30, this.magneticDeclination));
                
                document.getElementById('magneticDeclination').textContent = this.magneticDeclination.toFixed(1) + '°';
            }

            async setupCamera() {
                if (!this.cameraPermission) {
                    throw new Error('لم يتم منح صلاحية الكاميرا');
                }

                return this.getUserMedia();
            }

            async getUserMedia() {
                try {
                    const constraints = {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1920, min: 1280 },
                            height: { ideal: 1080, min: 720 },
                            frameRate: { ideal: 30, min: 15 }
                        }
                    };

                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = stream;
                    
                    return new Promise((resolve) => {
                        this.video.onloadedmetadata = () => {
                            resolve();
                        };
                    });
                } catch (error) {
                    throw new Error('فشل في تشغيل الكاميرا: ' + error.message);
                }
            }

            async setupSensors() {
                if (!this.orientationPermission) {
                    throw new Error('لا توجد صلاحية لأجهزة الاستشعار');
                }

                window.addEventListener('deviceorientation', (event) => {
                    if (event.alpha !== null) {
                        this.deviceHeading = (event.alpha + this.magneticDeclination + 360) % 360;
                    }
                    if (event.beta !== null) {
                        this.deviceTilt = event.beta;
                    }
                    if (event.gamma !== null) {
                        this.deviceRoll = event.gamma;
                    }
                    
                    this.updateSensorDisplay();
                });

                this.startCalibration();
            }

            startCalibration() {
                let calibrationSamples = [];
                let sampleCount = 0;
                
                const calibrationInterval = setInterval(() => {
                    if (this.deviceHeading !== 0) {
                        calibrationSamples.push(this.deviceHeading);
                        sampleCount++;
                        
                        if (sampleCount >= 10) {
                            const average = calibrationSamples.reduce((a, b) => a + b) / calibrationSamples.length;
                            this.calibrationOffset = average - this.deviceHeading;
                            this.calibrated = true;
                            clearInterval(calibrationInterval);
                        }
                    }
                }, 100);
            }

            generateCompassMarkings() {
                const markingsContainer = document.querySelector('.compass-markings');
                markingsContainer.innerHTML = '';
                
                for (let i = 0; i < 360; i += 15) {
                    const mark = document.createElement('div');
                    mark.className = i % 45 === 0 ? 'compass-mark major' : 'compass-mark';
                    mark.style.transform = `translateX(-50%) rotate(${i}deg)`;
                    markingsContainer.appendChild(mark);
                }
            }

            updateSensorDisplay() {
                document.getElementById('deviceHeading').textContent = this.deviceHeading.toFixed(0) + '°';
                document.getElementById('deviceTilt').textContent = this.deviceTilt.toFixed(0) + '°';
                
                const needle = document.getElementById('compassNeedle');
                needle.style.transform = `translateX(-50%) rotate(${this.deviceHeading}deg)`;
                
                const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
                const directionIndex = Math.round(this.deviceHeading / 22.5) % 16;
                document.getElementById('compassDirection').textContent = directions[directionIndex];
            }

            setupEventListeners() {
                this.satelliteSelect.addEventListener('change', () => {
                    this.selectedSatellite = this.satelliteSelect.value;
                    this.updateSatelliteInfo();
                });

                window.addEventListener('orientationchange', () => {
                    setTimeout(() => {
                        this.updateDisplay();
                    }, 500);
                });

                // Continuous updates
                this.updateInterval = setInterval(() => {
                    this.updateDisplay();
                }, 100);
            }

            startUpdates() {
                this.updateDisplay();
            }

            updateSatelliteInfo() {
                if (!this.selectedSatellite) {
                    this.satelliteInfo.classList.remove('visible');
                    return;
                }

                const satellite = this.satellites[this.selectedSatellite];
                const satName = satellite.name[currentLanguage] || satellite.name.en;
                const satDesc = satellite.description[currentLanguage] || satellite.description.en;
                const satFootprint = satellite.footprint[currentLanguage] || satellite.footprint.en;
                const satOperator = satellite.operator[currentLanguage] || satellite.operator.en;
                
                document.getElementById('satName').textContent = satName;
                document.getElementById('satDetails').innerHTML = `
                    <strong>خط الطول:</strong> ${satellite.longitude}°<br>
                    <strong>الوصف:</strong> ${satDesc}<br>
                    <strong>التغطية:</strong> ${satFootprint}<br>
                    <strong>المشغل:</strong> ${satOperator}<br>
                    <strong>القدرة:</strong> ${satellite.power}<br>
                    <strong>ترددات عينة:</strong><br>
                    ${satellite.frequencies.slice(0, 3).join('<br>')}
                `;
                this.satelliteInfo.classList.add('visible');
            }

            calculatePreciseSatellitePosition(satLongitude) {
                if (!this.userLat || !this.userLon) return null;

                const userLatRad = this.userLat * Math.PI / 180;
                const userLonRad = this.userLon * Math.PI / 180;
                const satLonRad = satLongitude * Math.PI / 180;
                const deltaLon = satLonRad - userLonRad;

                // Precise geostationary orbit calculations
                const earthRadius = 6371000; // meters
                const satAltitude = 35786000; // meters  
                const satRadius = earthRadius + satAltitude;

                const cosUserLat = Math.cos(userLatRad);
                const sinUserLat = Math.sin(userLatRad);
                const cosDeltaLon = Math.cos(deltaLon);
                const sinDeltaLon = Math.sin(deltaLon);

                // Calculate azimuth with high precision
                const azimuthRad = Math.atan2(sinDeltaLon, cosUserLat * Math.tan(0) - sinUserLat * cosDeltaLon);
                let azimuth = (azimuthRad * 180 / Math.PI + 360) % 360;

                // Correction for southern hemisphere
                if (this.userLat < 0) {
                    azimuth = (180 - azimuth + 360) % 360;
                }

                // Calculate elevation with high precision
                const groundDistance = earthRadius * Math.acos(sinUserLat * Math.sin(0) + cosUserLat * Math.cos(0) * cosDeltaLon);
                const slantRange = Math.sqrt(Math.pow(satRadius, 2) + Math.pow(earthRadius, 2) - 2 * satRadius * earthRadius * Math.cos(groundDistance / earthRadius));
                const elevationRad = Math.asin((satRadius * Math.sin(groundDistance / earthRadius)) / slantRange) - (groundDistance / earthRadius);
                const elevation = Math.max(0, elevationRad * 180 / Math.PI);

                // Calculate LNB skew/polarization angle
                const skewRad = Math.atan2(sinDeltaLon * sinUserLat, Math.cos(0) * cosUserLat - Math.sin(0) * sinUserLat * cosDeltaLon);
                const skew = skewRad * 180 / Math.PI;

                return {
                    azimuth: Math.round(azimuth * 100) / 100,
                    elevation: Math.round(elevation * 100) / 100,
                    skew: Math.round(skew * 100) / 100,
                    distance: Math.round(slantRange / 1000),
                    valid: elevation > 0,
                    slantRange: slantRange
                };
            }

            updateDisplay() {
                if (!this.selectedSatellite || !this.userLat) {
                    this.updateAlignmentStatus(
                        t('status.searching', 'البحث عن القمر الصناعي'),
                        t('status.instructions', 'اختر قمر صناعي من الأعلى للبدء'), 
                        0
                    );
                    return;
                }

                const satellite = this.satellites[this.selectedSatellite];
                const position = this.calculatePreciseSatellitePosition(satellite.longitude);

                if (!position || !position.valid) {
                    this.updateAlignmentStatus(
                        'القمر الصناعي غير مرئي',
                        'القمر الصناعي تحت الأفق من موقعك', 
                        0
                    );
                    return;
                }

                // Update displayed values
                document.getElementById('azimuth').textContent = position.azimuth.toFixed(1) + '°';
                document.getElementById('elevation').textContent = position.elevation.toFixed(1) + '°';
                document.getElementById('skew').textContent = position.skew.toFixed(1) + '°';
                document.getElementById('coordDistance').textContent = position.distance + ' km';

                // Calculate alignment precision
                const angleDiff = this.calculateAngleDifference(this.deviceHeading, position.azimuth);
                const tiltDiff = Math.abs(this.deviceTilt - position.elevation);
                
                const azimuthAccuracy = Math.max(0, 100 - (angleDiff * 2));
                const elevationAccuracy = Math.max(0, 100 - (tiltDiff * 4));
                const overallAccuracy = (azimuthAccuracy + elevationAccuracy) / 2;

                this.updateAlignmentStatus(
                    this.getAlignmentStatusText(overallAccuracy),
                    this.getAlignmentDetails(angleDiff, tiltDiff, position),
                    overallAccuracy
                );

                // Draw professional satellite marker
                this.drawProfessionalSatelliteMarker(position, angleDiff, elevationAccuracy);
            }

            calculateAngleDifference(angle1, angle2) {
                let diff = Math.abs(angle1 - angle2);
                return Math.min(diff, 360 - diff);
            }

            getAlignmentStatusText(accuracy) {
                if (accuracy >= 95) return t('status.perfect', 'توجيه مثالي محقق');
                if (accuracy >= 85) return t('status.excellent', 'توجيه ممتاز');
                if (accuracy >= 70) return t('status.good', 'توجيه جيد');
                if (accuracy >= 50) return t('status.fair', 'توجيه متوسط');
                if (accuracy >= 30) return t('status.poor', 'توجيه ضعيف');
                return t('status.none', 'لا يوجد توجيه');
            }

            getAlignmentDetails(angleDiff, tiltDiff, position) {
                let details = [];
                
                if (angleDiff > 2) {
                    const direction = this.deviceHeading < position.azimuth ? 
                        t('alignment.turnRight', 'استدر يميناً') : 
                        t('alignment.turnLeft', 'استدر يساراً');
                    details.push(`${direction} ${Math.round(angleDiff)}°`);
                }
                
                if (tiltDiff > 1) {
                    const direction = this.deviceTilt < position.elevation ? 
                        t('alignment.tiltUp', 'اتجه للأعلى') : 
                        t('alignment.tiltDown', 'اتجه للأسفل');
                    details.push(`${direction} ${Math.round(tiltDiff)}°`);
                }
                
                if (details.length === 0) {
                    details.push(t('alignment.perfect', 'الطبق موجه بشكل مثالي نحو القمر الصناعي'));
                }
                
                details.push(`${t('alignment.distance', 'المسافة')}: ${position.distance} km`);
                
                return details.join(' • ');
            }

            updateAlignmentStatus(status, details, accuracy) {
                document.getElementById('alignmentStatus').textContent = status;
                document.getElementById('alignmentDetails').textContent = details;
                
                const signalBar = document.getElementById('signalBar');
                const signalText = document.getElementById('signalText');
                
                signalBar.style.width = accuracy + '%';
                signalText.textContent = `${t('status.precision', 'دقة التوجيه')}: ${Math.round(accuracy)}%`;
            }

            drawProfessionalSatelliteMarker(position, angleDiff, elevationAccuracy) {
                this.markersContainer.innerHTML = '';

                if (angleDiff < 90 && elevationAccuracy > 10) {
                    const marker = document.createElement('div');
                    marker.className = 'satellite-marker';

                    const markerContainer = document.createElement('div');
                    markerContainer.className = 'marker-container';

                    const markerCircle = document.createElement('div');
                    markerCircle.className = 'marker-circle';

                    // Professional satellite icon
                    const icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    icon.setAttribute('class', 'marker-icon');
                    icon.setAttribute('viewBox', '0 0 24 24');
                    icon.innerHTML = `
                        <path d="M12 2C12.5523 2 13 2.44772 13 3V5C13 5.55228 12.5523 6 12 6C11.4477 6 11 5.55228 11 5V3C11 2.44772 11.4477 2 12 2Z"/>
                        <path d="M12 18C12.5523 18 13 18.4477 13 19V21C13 21.5523 12.5523 22 12 22C11.4477 22 11 21.5523 11 21V19C11 18.4477 11.4477 18 12 18Z"/>
                        <path d="M22 12C22 12.5523 21.5523 13 21 13H19C18.4477 13 18 12.5523 18 12C18 11.4477 18.4477 11 19 11H21C21.5523 11 22 11.4477 22 12Z"/>
                        <path d="M6 12C6 12.5523 5.55228 13 5 13H3C2.44772 13 2 12.5523 2 12C2 11.4477 2.44772 11 3 11H5C5.55228 11 6 11.4477 6 12Z"/>
                        <circle cx="12" cy="12" r="3"/>
                    `;
                    markerCircle.appendChild(icon);

                    // Determine marker color based on precision
                    if (angleDiff < 2 && elevationAccuracy > 95) {
                        markerCircle.classList.add('aligned');
                    } else if (angleDiff < 5 && elevationAccuracy > 80) {
                        markerCircle.classList.add('close');
                    }

                    const label = document.createElement('div');
                    label.className = 'marker-label';
                    const satellite = this.satellites[this.selectedSatellite];
                    label.textContent = satellite.name[currentLanguage] || satellite.name.en;

                    markerContainer.appendChild(markerCircle);
                    markerContainer.appendChild(label);
                    marker.appendChild(markerContainer);

                    // Calculate marker position on screen
                    const screenWidth = window.innerWidth;
                    const screenHeight = window.innerHeight;

                    const relativeAzimuth = position.azimuth - this.deviceHeading;
                    const relativeElevation = position.elevation - this.deviceTilt;

                    // Convert relative angles to screen coordinates
                    const x = screenWidth / 2 + (relativeAzimuth * screenWidth / 90);
                    const y = screenHeight / 2 - (relativeElevation * screenHeight / 90);

                    // Ensure marker stays within screen bounds
                    const clampedX = Math.max(80, Math.min(screenWidth - 80, x));
                    const clampedY = Math.max(120, Math.min(screenHeight - 120, y));

                    marker.style.left = clampedX + 'px';
                    marker.style.top = clampedY + 'px';

                    this.markersContainer.appendChild(marker);
                }
            }

            showError(title, message) {
                const errorDialog = document.createElement('div');
                errorDialog.className = 'error-dialog';
                errorDialog.innerHTML = `
                    <div class="error-title">${title}</div>
                    <div class="error-message">${message}</div>
                `;
                document.body.appendChild(errorDialog);

                setTimeout(() => {
                    if (errorDialog.parentNode) {
                        errorDialog.parentNode.removeChild(errorDialog);
                    }
                }, 5000);
            }

            destroy() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                }
                
                if (this.video && this.video.srcObject) {
                    const tracks = this.video.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                }
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial language
            updateTranslations();
            
            // Initialize the main application
            satApp = new ProfessionalSatelliteFinder();
        });

        // Professional screen wake lock
        let wakeLock = null;
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').then((lock) => {
                wakeLock = lock;
                console.log('تم تفعيل منع قفل الشاشة');
            }).catch(err => {
                console.log('فشل في منع قفل الشاشة:', err);
            });
        }

        // Handle app lifecycle
        window.addEventListener('beforeunload', () => {
            if (wakeLock) {
                wakeLock.release();
            }
            if (satApp) {
                satApp.destroy();
            }
        });

        // Handle visibility changes for battery optimization
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log('التطبيق نشط مرة أخرى');
                
                // Re-acquire wake lock if needed
                if ('wakeLock' in navigator && !wakeLock) {
                    navigator.wakeLock.request('screen').then((lock) => {
                        wakeLock = lock;
                    }).catch(err => {
                        console.log('فشل في إعادة تفعيل منع قفل الشاشة:', err);
                    });
                }
            } else {
                // Release wake lock when app is hidden to save battery
                if (wakeLock) {
                    wakeLock.release();
                    wakeLock = null;
                }
            }
        });

        // Professional error handling
        window.addEventListener('error', (event) => {
            console.error('خطأ عام:', event.error);
            if (satApp) {
                satApp.showError('خطأ في التطبيق', 'حدث خطأ غير متوقع. يرجى إعادة تحميل الصفحة.');
            }
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            console.error('رفض غير معالج للوعد:', event.reason);
            event.preventDefault();
            if (satApp) {
                satApp.showError('خطأ في النظام', 'حدث خطأ في النظام. يرجى المحاولة مرة أخرى.');
            }
        });

        // Performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', () => {
                const perfData = performance.getEntriesByType('navigation')[0];
                console.log('مقاييس أداء التطبيق:', {
                    loadTime: perfData.loadEventEnd - perfData.loadEventStart,
                    domContentLoaded: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
                    totalTime: perfData.loadEventEnd - perfData.fetchStart
                });
            });
        }

        // Professional console branding
        console.log(`
%c╔═══════════════════════════════════════╗
║        SatAlign Pro Enterprise        ║
║     Professional Satellite Finder    ║
║                                       ║
║    🛰️  مبني بدقة واهتمام             ║
║    🎯  أداء على مستوى المؤسسات        ║
║    🌍  دعم متعدد اللغات               ║
║    📱  هيكلة PWA احترافية             ║
║                                       ║
║         © 2024 SatAlign Pro           ║
╚═══════════════════════════════════════╝`, 
            'color: #0066cc; font-family: monospace; font-size: 12px; line-height: 1.4;'
        );
    </script>
</body>
</html>
                    
