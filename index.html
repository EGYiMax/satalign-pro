<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SatAlign Pro - Ù…Ø­Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Meta tags Ù„Ù„Ù€ PWA -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SatAlign Pro">
    
    <!-- Icons Ù„Ù„Ù€ PWA -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3ccircle cx='50' cy='50' r='40' fill='%23007aff'/%3e%3ctext x='50' y='60' font-size='40' text-anchor='middle' fill='white'%3eğŸ“¡%3c/text%3e%3c/svg%3e">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'San Francisco', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            position: relative;
            height: 100vh;
            user-select: none;
        }

        #video {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .hud-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 15;
        }

        .top-panel {
            position: absolute;
            top: env(safe-area-inset-top, 20px);
            left: 20px;
            right: 20px;
            z-index: 20;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            pointer-events: all;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .satellite-selector {
            margin-bottom: 16px;
        }

        .selector-label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
        }

        select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: left 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-left: 40px;
        }

        .precision-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .precision-item {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px 8px;
            border-radius: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .precision-label {
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .precision-value {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .status-item {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }

        .status-label {
            font-size: 10px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 2px;
        }

        .status-value {
            font-size: 14px;
            font-weight: 600;
        }

        .satellite-marker {
            position: absolute;
            width: 50px;
            height: 50px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .marker-circle {
            width: 100%;
            height: 100%;
            border: 3px solid #ff3b30;
            border-radius: 50%;
            background: rgba(255,59,48,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            animation: pulse 2s infinite;
            box-shadow: 0 0 30px rgba(255,59,48,0.5);
        }

        .marker-circle.aligned {
            border-color: #30d158;
            background: rgba(48,209,88,0.2);
            box-shadow: 0 0 30px rgba(48,209,88,0.5);
        }

        .marker-circle.close {
            border-color: #ff9f0a;
            background: rgba(255,159,10,0.2);
            box-shadow: 0 0 30px rgba(255,159,10,0.5);
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .crosshair-circle {
            width: 100%;
            height: 100%;
            border: 2px solid #007aff;
            border-radius: 50%;
            position: relative;
            background: rgba(0,122,255,0.1);
        }

        .crosshair-lines {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .crosshair-h, .crosshair-v {
            position: absolute;
            background: #007aff;
        }

        .crosshair-h {
            width: 30px;
            height: 2px;
            left: -15px;
            top: -1px;
        }

        .crosshair-v {
            width: 2px;
            height: 30px;
            left: -1px;
            top: -15px;
        }

        .compass-container {
            position: absolute;
            bottom: env(safe-area-inset-bottom, 20px);
            right: 20px;
            width: 100px;
            height: 100px;
        }

        .compass {
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            position: relative;
            overflow: hidden;
        }

        .compass-needle {
            position: absolute;
            width: 2px;
            height: 35px;
            background: #ff3b30;
            top: 10px;
            left: 50%;
            transform-origin: bottom center;
            transform: translateX(-50%);
        }

        .alignment-indicator {
            position: absolute;
            bottom: env(safe-area-inset-bottom, 20px);
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        .alignment-status {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .alignment-details {
            font-size: 14px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 12px;
        }

        .signal-strength {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .signal-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff3b30, #ff9f0a, #30d158);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .satellite-info {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 200px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .satellite-info.visible {
            opacity: 1;
        }

        .sat-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .sat-details {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
            line-height: 1.4;
        }

        .error-dialog {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,59,48,0.95);
            backdrop-filter: blur(20px);
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            max-width: 300px;
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 200;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .error-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .error-message {
            font-size: 14px;
            color: rgba(255,255,255,0.9);
        }

        .horizon-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255,255,255,0.3);
            pointer-events: none;
        }

        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #007aff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            color: rgba(255,255,255,0.8);
            text-align: center;
            margin-bottom: 10px;
        }

        .permission-buttons {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        .btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            min-width: 200px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #0056cc;
            transform: scale(1.05);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .btn.success {
            background: #30d158;
        }

        .permission-step {
            text-align: center;
            margin-bottom: 15px;
        }

        .step-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #007aff;
        }

        .step-description {
            font-size: 14px;
            color: rgba(255,255,255,0.8);
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...</div>
        <div id="loadingDetails" class="loading-text" style="font-size: 14px; color: rgba(255,255,255,0.6);"></div>
        <div id="permissionButtons" class="permission-buttons" style="display: none;">
            <div class="permission-step">
                <div class="step-title">Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div>
                <div class="step-description">Ù†Ø­ØªØ§Ø¬ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ø³Ù…Ø§Ø¡</div>
                <button class="btn" id="cameraBtn" onclick="requestCameraPermission()">
                    ğŸ“· Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                </button>
            </div>

            <div class="permission-step">
                <div class="step-title">Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
                <div class="step-description">Ù†Ø­ØªØ§Ø¬ Ù…ÙˆÙ‚Ø¹Ùƒ Ù„Ø­Ø³Ø§Ø¨ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ© Ø¨Ø¯Ù‚Ø©</div>
                <button class="btn" id="locationBtn" onclick="requestLocationPermission()" disabled>
                    ğŸŒ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                </button>
            </div>

            <div class="permission-step">
                <div class="step-title">Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø§Ø³ØªØ´Ø¹Ø§Ø±</div>
                <div class="step-description">Ù†Ø­ØªØ§Ø¬ Ø§Ù„Ø¨ÙˆØµÙ„Ø© ÙˆÙ…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø¥Ù…Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¬Ù‡Ø§Ø²</div>
                <button class="btn" id="orientationBtn" onclick="requestOrientationPermission()" disabled>
                    ğŸ§­ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø§Ø³ØªØ´Ø¹Ø§Ø±
                </button>
            </div>

            <div class="permission-step" id="startStep" style="display: none;">
                <div class="step-title">ğŸ‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…ÙÙ†Ø­Øª Ø¨Ù†Ø¬Ø§Ø­!</div>
                <div class="step-description">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨ÙƒØ§Ù…Ù„ Ø¥Ù…ÙƒØ§Ù†ÙŠØ§ØªÙ‡</div>
                <button class="btn success" onclick="finishSetup()">
                    ğŸš€ Ø¨Ø¯Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                </button>
            </div>
        </div>
    </div>

    <video id="video" autoplay playsinline muted></video>
    
    <div class="overlay">
        <div class="crosshair">
            <div class="crosshair-circle">
                <div class="crosshair-lines">
                    <div class="crosshair-h"></div>
                    <div class="crosshair-v"></div>
                </div>
            </div>
        </div>
        <div id="satelliteMarkers"></div>
        <div id="horizonLine" class="horizon-line"></div>
        <div id="elevationArcs"></div>
    </div>

    <div class="hud-overlay">
        <div class="top-panel">
            <div class="satellite-selector">
                <div class="selector-label">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ</div>
                <select id="satelliteSelect">
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ --</option>
                    <optgroup label="Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">
                        <option value="nilesat-201">Ù†Ø§ÙŠÙ„ Ø³Ø§Øª 201 (7Â°W)</option>
                        <option value="nilesat-301">Ù†Ø§ÙŠÙ„ Ø³Ø§Øª 301 (7Â°W)</option>
                        <option value="arabsat-5a">Ø¹Ø±Ø¨Ø³Ø§Øª 5A (30.5Â°E)</option>
                        <option value="arabsat-5c">Ø¹Ø±Ø¨Ø³Ø§Øª 5C (20Â°E)</option>
                        <option value="badr-4">Ø¨Ø¯Ø± 4 (26Â°E)</option>
                        <option value="badr-5">Ø¨Ø¯Ø± 5 (26Â°E)</option>
                        <option value="badr-6">Ø¨Ø¯Ø± 6 (26Â°E)</option>
                        <option value="badr-7">Ø¨Ø¯Ø± 7 (26Â°E)</option>
                        <option value="badr-8">Ø¨Ø¯Ø± 8 (26Â°E)</option>
                    </optgroup>
                    <optgroup label="Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„Ø£ÙˆØ±ÙˆØ¨ÙŠØ©">
                        <option value="hotbird-13f">Ù‡ÙˆØª Ø¨ÙŠØ±Ø¯ 13F (13Â°E)</option>
                        <option value="hotbird-13g">Ù‡ÙˆØª Ø¨ÙŠØ±Ø¯ 13G (13Â°E)</option>
                        <option value="astra-1kr">Ø£Ø³ØªØ±Ø§ 1KR (19.2Â°E)</option>
                        <option value="astra-1l">Ø£Ø³ØªØ±Ø§ 1L (19.2Â°E)</option>
                        <option value="astra-1m">Ø£Ø³ØªØ±Ø§ 1M (19.2Â°E)</option>
                        <option value="astra-1n">Ø£Ø³ØªØ±Ø§ 1N (19.2Â°E)</option>
                        <option value="eutelsat-16a">ÙŠÙˆØªÙ„Ø³Ø§Øª 16A (16Â°E)</option>
                        <option value="eutelsat-7c">ÙŠÙˆØªÙ„Ø³Ø§Øª 7C (7Â°E)</option>
                    </optgroup>
                    <optgroup label="Ø£Ù‚Ù…Ø§Ø± Ø£Ø®Ø±Ù‰">
                        <option value="turksat-4a">ØªÙˆØ±Ùƒ Ø³Ø§Øª 4A (42Â°E)</option>
                        <option value="turksat-4b">ØªÙˆØ±Ùƒ Ø³Ø§Øª 4B (42Â°E)</option>
                        <option value="hispasat-30w-6">Ù‡ÙŠØ³Ø¨Ø§Ø³Ø§Øª 30W-6 (30Â°W)</option>
                        <option value="intelsat-33e">Ø¥Ù†ØªÙ„Ø³Ø§Øª 33e (60Â°E)</option>
                        <option value="amos-17">Ø¹Ø§Ù…ÙˆØ³ 17 (17Â°E)</option>
                    </optgroup>
                </select>
            </div>
            
            <div class="precision-grid">
                <div class="precision-item">
                    <div class="precision-label">Ø§ØªØ¬Ø§Ù‡</div>
                    <div class="precision-value" id="azimuth">--Â°</div>
                </div>
                <div class="precision-item">
                    <div class="precision-label">Ø§Ø±ØªÙØ§Ø¹</div>
                    <div class="precision-value" id="elevation">--Â°</div>
                </div>
                <div class="precision-item">
                    <div class="precision-label">Ø§Ù†Ø­Ø±Ø§Ù</div>
                    <div class="precision-value" id="skew">--Â°</div>
                </div>
            </div>
            
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²</div>
                    <div class="status-value" id="deviceHeading">--Â°</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Ø¥Ù…Ø§Ù„Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²</div>
                    <div class="status-value" id="deviceTilt">--Â°</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Ø¯Ù‚Ø© GPS</div>
                    <div class="status-value" id="gpsAccuracy">--Ù…</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…ØºÙ†Ø§Ø·ÙŠØ³ÙŠ</div>
                    <div class="status-value" id="magneticDeclination">--Â°</div>
                </div>
            </div>
        </div>

        <div class="compass-container">
            <div class="compass">
                <div class="compass-needle" id="compassNeedle"></div>
                <div id="compassDirection">N</div>
            </div>
        </div>

        <div class="alignment-indicator">
            <div class="alignment-status" id="alignmentStatus">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ</div>
            <div class="alignment-details" id="alignmentDetails">Ø§Ø®ØªØ± Ù‚Ù…Ø± ØµÙ†Ø§Ø¹ÙŠ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø¨Ø¯Ø¡</div>
            <div class="signal-strength">
                <div class="signal-bar" id="signalBar" style="width: 0%"></div>
            </div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.6);" id="signalText">Ø¯Ù‚Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡: 0%</div>
        </div>

        <div class="satellite-info" id="satelliteInfo">
            <div class="sat-name" id="satName"></div>
            <div class="sat-details" id="satDetails"></div>
        </div>
    </div>

    <script>
        // Ù…ØªØºÙŠØ± Ø¹Ø§Ù… Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
        let satApp = null;

        // Functions Ù„Ø·Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† global Ù„ØªØ¹Ù…Ù„ Ù…Ø¹ onclick)
        async function requestCameraPermission() {
            const btn = document.getElementById('cameraBtn');
            const locationBtn = document.getElementById('locationBtn');
            
            try {
                btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©...';
                btn.disabled = true;

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³ØªØ±ÙŠÙ… Ù…Ø¤Ù‚ØªØ§Ù‹
                stream.getTracks().forEach(track => track.stop());
                
                btn.textContent = 'âœ… ØªÙ… Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
                btn.classList.add('success');
                satApp.cameraPermission = true;
                
                // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ
                locationBtn.disabled = false;
                
            } catch (error) {
                btn.textContent = 'âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©';
                btn.style.background = '#ff3b30';
                
                setTimeout(() => {
                    btn.textContent = 'ğŸ“· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©';
                    btn.style.background = '#007aff';
                    btn.disabled = false;
                }, 3000);
            }
        }

        async function requestLocationPermission() {
            const btn = document.getElementById('locationBtn');
            const orientationBtn = document.getElementById('orientationBtn');
            
            try {
                btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...';
                btn.disabled = true;

                await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            satApp.userLat = position.coords.latitude;
                            satApp.userLon = position.coords.longitude;
                            satApp.gpsAccuracy = Math.round(position.coords.accuracy);
                            resolve();
                        },
                        (error) => reject(error),
                        { enableHighAccuracy: true, timeout: 15000 }
                    );
                });
                
                btn.textContent = 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­';
                btn.classList.add('success');
                satApp.locationPermission = true;
                
                // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ
                orientationBtn.disabled = false;
                
            } catch (error) {
                btn.textContent = 'âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                btn.style.background = '#ff3b30';
                
                setTimeout(() => {
                    btn.textContent = 'ğŸŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©';
                    btn.style.background = '#007aff';
                    btn.disabled = false;
                }, 3000);
            }
        }

        async function requestOrientationPermission() {
            const btn = document.getElementById('orientationBtn');
            const startStep = document.getElementById('startStep');
            
            try {
                btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø§Ø³ØªØ´Ø¹Ø§Ø±...';
                btn.disabled = true;

                // Ù„Ù„Ø§ÙŠÙÙˆÙ†
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') {
                        throw new Error('ØªÙ… Ø±ÙØ¶ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
                    }
                }
                
                btn.textContent = 'âœ… ØªÙ… Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø§Ø³ØªØ´Ø¹Ø§Ø±';
                btn.classList.add('success');
                satApp.orientationPermission = true;
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡
                startStep.style.display = 'block';
                
            } catch (error) {
                btn.textContent = 'âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©';
                btn.style.background = '#ff3b30';
                
                setTimeout(() => {
                    btn.textContent = 'ğŸ§­ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©';
                    btn.style.background = '#007aff';
                    btn.disabled = false;
                }, 3000);
            }
        }

        async function finishSetup() {
            const loadingScreen = document.getElementById('loadingScreen');
            const loadingDetails = document.getElementById('loadingDetails');
            
            try {
                loadingDetails.textContent = 'Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…ØºÙ†Ø§Ø·ÙŠØ³ÙŠ...';
                await satApp.calculateMagneticDeclination();
                
                loadingDetails.textContent = 'ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...';
                await satApp.getUserMedia();
                
                loadingDetails.textContent = 'ØªÙ‡ÙŠØ¦Ø© Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø§Ø³ØªØ´Ø¹Ø§Ø±...';
                await satApp.setupSensors();
                
                loadingDetails.textContent = 'ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...';
                satApp.setupEventListeners();
                
                loadingDetails.textContent = 'Ù…ÙƒØªÙ…Ù„!';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    satApp.startUpdates();
                }, 500);
                
            } catch (error) {
                satApp.showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©', error.message);
            }
        }

        class ProfessionalSatelliteFinder {
            constructor() {
                this.initializeElements();
                this.initializeData();
                this.initializeState();
                this.startInitialization();
            }

            initializeElements() {
                this.video = document.getElementById('video');
                this.satelliteSelect = document.getElementById('satelliteSelect');
                this.loadingScreen = document.getElementById('loadingScreen');
                this.loadingDetails = document.getElementById('loadingDetails');
                this.permissionButtons = document.getElementById('permissionButtons');
                this.markersContainer = document.getElementById('satelliteMarkers');
                this.satelliteInfo = document.getElementById('satelliteInfo');
            }

            initializeData() {
                this.satellites = {
                    'nilesat-201': {
                        name: 'Ù†Ø§ÙŠÙ„ Ø³Ø§Øª 201',
                        longitude: -7.0,
                        description: 'Ø§Ù„Ù‚Ù…Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø´Ø±Ù‚ Ø§Ù„Ø£ÙˆØ³Ø· ÙˆØ´Ù…Ø§Ù„ Ø£ÙØ±ÙŠÙ‚ÙŠØ§',
                        frequencies: ['11747 H', '11766 V', '11785 H', '11804 V'],
                        footprint: 'MENA',
                        power: '8.5 kW'
                    },
                    'nilesat-301': {
                        name: 'Ù†Ø§ÙŠÙ„ Ø³Ø§Øª 301',
                        longitude: -7.0,
                        description: 'Ø£Ø­Ø¯Ø« Ø£Ù‚Ù…Ø§Ø± Ù†Ø§ÙŠÙ„ Ø³Ø§Øª Ø¨ØªÙ‚Ù†ÙŠØ© Ø¹Ø§Ù„ÙŠØ©',
                        frequencies: ['11823 H', '11842 V', '11861 H', '11880 V'],
                        footprint: 'MENA',
                        power: '12 kW'
                    },
                    'arabsat-5a': {
                        name: 'Ø¹Ø±Ø¨Ø³Ø§Øª 5A',
                        longitude: 30.5,
                        description: 'ÙŠØºØ·ÙŠ Ø§Ù„Ø´Ø±Ù‚ Ø§Ù„Ø£ÙˆØ³Ø· ÙˆØ´Ù…Ø§Ù„ Ø£ÙØ±ÙŠÙ‚ÙŠØ§',
                        frequencies: ['11996 V', '12015 H', '12034 V', '12053 H'],
                        footprint: 'MENA + Europe',
                        power: '10.5 kW'
                    },
                    'arabsat-5c': {
                        name: 'Ø¹Ø±Ø¨Ø³Ø§Øª 5C',
                        longitude: 20.0,
                        description: 'Ø®Ø¯Ù…Ø§Øª ÙØ§Ø¦Ù‚Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© Ù„Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
                        frequencies: ['11900 V', '11919 H', '11938 V', '11957 H'],
                        footprint: 'MENA',
                        power: '9.8 kW'
                    },
                    'badr-4': {
                        name: 'Ø¨Ø¯Ø± 4',
                        longitude: 26.0,
                        description: 'Ù‚Ù…Ø± Ø¹Ø±Ø¨ÙŠ Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ø§ØªØµØ§Ù„Ø§Øª',
                        frequencies: ['11996 V', '12015 H', '12034 V'],
                        footprint: 'MENA + South Asia',
                        power: '8.2 kW'
                    },
                    'badr-5': {
                        name: 'Ø¨Ø¯Ø± 5',
                        longitude: 26.0,
                        description: 'ØªØ­Ø¯ÙŠØ« Ù…ØªÙ‚Ø¯Ù… Ù„Ø´Ø¨ÙƒØ© Ø¨Ø¯Ø±',
                        frequencies: ['12053 H', '12072 V', '12091 H'],
                        footprint: 'MENA + South Asia',
                        power: '9.5 kW'
                    },
                    'badr-6': {
                        name: 'Ø¨Ø¯Ø± 6',
                        longitude: 26.0,
                        description: 'Ø£Ø­Ø¯Ø« Ø¬ÙŠÙ„ Ù…Ù† Ø£Ù‚Ù…Ø§Ø± Ø¨Ø¯Ø±',
                        frequencies: ['12110 V', '12129 H', '12148 V'],
                        footprint: 'MENA + South Asia',
                        power: '11.2 kW'
                    },
                    'badr-7': {
                        name: 'Ø¨Ø¯Ø± 7',
                        longitude: 26.0,
                        description: 'ØªÙ‚Ù†ÙŠØ© ÙØ§Ø¦Ù‚Ø© Ø§Ù„Ø­Ø¯Ø§Ø«Ø©',
                        frequencies: ['12167 H', '12186 V', '12205 H'],
                        footprint: 'MENA + South Asia',
                        power: '12.5 kW'
                    },
                    'badr-8': {
                        name: 'Ø¨Ø¯Ø± 8',
                        longitude: 26.0,
                        description: 'Ø£Ø­Ø¯Ø« Ø¥Ø¶Ø§ÙØ© Ù„Ø£Ø³Ø·ÙˆÙ„ Ø¨Ø¯Ø±',
                        frequencies: ['12224 V', '12243 H', '12262 V'],
                        footprint: 'MENA + South Asia',
                        power: '13.8 kW'
                    },
                    'hotbird-13f': {
                        name: 'Ù‡ÙˆØª Ø¨ÙŠØ±Ø¯ 13F',
                        longitude: 13.0,
                        description: 'Ø§Ù„Ù‚Ù…Ø± Ø§Ù„Ø£ÙˆØ±ÙˆØ¨ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ',
                        frequencies: ['10723 H', '10742 V', '10761 H', '10780 V'],
                        footprint: 'Europe + North Africa',
                        power: '15.2 kW'
                    },
                    'hotbird-13g': {
                        name: 'Ù‡ÙˆØª Ø¨ÙŠØ±Ø¯ 13G',
                        longitude: 13.0,
                        description: 'ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯ Ù„Ù‡ÙˆØª Ø¨ÙŠØ±Ø¯',
                        frequencies: ['10799 H', '10818 V', '10837 H', '10856 V'],
                        footprint: 'Europe + North Africa',
                        power: '16.1 kW'
                    },
                    'astra-1kr': {
                        name: 'Ø£Ø³ØªØ±Ø§ 1KR',
                        longitude: 19.2,
                        description: 'Ù‚Ù…Ø± Ø£ÙˆØ±ÙˆØ¨ÙŠ Ù…ØªÙ‚Ø¯Ù…',
                        frequencies: ['10714 H', '10744 V', '10773 H', '10803 V'],
                        footprint: 'Europe',
                        power: '14.8 kW'
                    },
                    'astra-1l': {
                        name: 'Ø£Ø³ØªØ±Ø§ 1L',
                        longitude: 19.2,
                        description: 'Ø£Ø³ØªØ±Ø§ Ø§Ù„Ø­Ø¯ÙŠØ«',
                        frequencies: ['10832 H', '10862 V', '10891 H', '10920 V'],
                        footprint: 'Europe',
                        power: '15.5 kW'
                    },
                    'astra-1m': {
                        name: 'Ø£Ø³ØªØ±Ø§ 1M',
                        longitude: 19.2,
                        description: 'ØªØ·ÙˆÙŠØ± Ù…ØªÙ‚Ø¯Ù… Ù„Ø£Ø³ØªØ±Ø§',
                        frequencies: ['10949 V', '10979 H', '11008 V', '11038 H'],
                        footprint: 'Europe',
                        power: '16.2 kW'
                    },
                    'astra-1n': {
                        name: 'Ø£Ø³ØªØ±Ø§ 1N',
                        longitude: 19.2,
                        description: 'Ø£Ø­Ø¯Ø« Ø£Ù‚Ù…Ø§Ø± Ø£Ø³ØªØ±Ø§',
                        frequencies: ['11068 V', '11097 H', '11127 V', '11156 H'],
                        footprint: 'Europe',
                        power: '17.1 kW'
                    },
                    'eutelsat-16a': {
                        name: 'ÙŠÙˆØªÙ„Ø³Ø§Øª 16A',
                        longitude: 16.0,
                        description: 'Ù‚Ù…Ø± Ø£ÙˆØ±ÙˆØ¨ÙŠ Ø´Ø§Ù…Ù„',
                        frequencies: ['11595 H', '11623 V', '11652 H', '11680 V'],
                        footprint: 'Europe + Africa',
                        power: '13.5 kW'
                    },
                    'eutelsat-7c': {
                        name: 'ÙŠÙˆØªÙ„Ø³Ø§Øª 7C',
                        longitude: 7.0,
                        description: 'ØªØºØ·ÙŠØ© Ø£ÙˆØ±ÙˆØ¨ÙŠØ© ÙˆØ£ÙØ±ÙŠÙ‚ÙŠØ©',
                        frequencies: ['11304 H', '11332 V', '11360 H', '11389 V'],
                        footprint: 'Europe + Africa',
                        power: '12.8 kW'
                    },
                    'turksat-4a': {
                        name: 'ØªÙˆØ±Ùƒ Ø³Ø§Øª 4A',
                        longitude: 42.0,
                        description: 'Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ØªØ±ÙƒÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ',
                        frequencies: ['11957 V', '11975 H', '12034 V', '12053 H'],
                        footprint: 'Turkey + Europe + MENA',
                        power: '11.8 kW'
                    },
                    'turksat-4b': {
                        name: 'ØªÙˆØ±Ùƒ Ø³Ø§Øª 4B',
                        longitude: 42.0,
                        description: 'ØªØ­Ø¯ÙŠØ« ØªÙˆØ±Ùƒ Ø³Ø§Øª',
                        frequencies: ['12072 V', '12091 H', '12110 V', '12129 H'],
                        footprint: 'Turkey + Europe + MENA',
                        power: '12.5 kW'
                    },
                    'hispasat-30w-6': {
                        name: 'Ù‡ÙŠØ³Ø¨Ø§Ø³Ø§Øª 30W-6',
                        longitude: -30.0,
                        description: 'Ù‚Ù…Ø± Ø£Ø·Ù„Ø³ÙŠ Ù…ØªÙ‚Ø¯Ù…',
                        frequencies: ['11876 H', '11934 V', '11992 H', '12051 V'],
                        footprint: 'Americas + Europe',
                        power: '14.2 kW'
                    },
                    'intelsat-33e': {
                        name: 'Ø¥Ù†ØªÙ„Ø³Ø§Øª 33e',
                        longitude: 60.0,
                        description: 'Ù‚Ù…Ø± Ø¢Ø³ÙŠÙˆÙŠ Ù…ØªØ·ÙˆØ±',
                        frequencies: ['11135 H', '11175 V', '11215 H', '11255 V'],
                        footprint: 'Asia + MENA',
                        power: '16.8 kW'
                    },
                    'amos-17': {
                        name: 'Ø¹Ø§Ù…ÙˆØ³ 17',
                        longitude: 17.0,
                        description: 'Ù‚Ù…Ø± Ø¥Ø³Ø±Ø§Ø¦ÙŠÙ„ÙŠ Ø­Ø¯ÙŠØ«',
                        frequencies: ['10843 V', '10883 H', '10923 V', '10963 H'],
                        footprint: 'Europe + Africa',
                        power: '10.5 kW'
                    }
                };
            }

            initializeState() {
                this.userLat = null;
                this.userLon = null;
                this.deviceHeading = 0;
                this.deviceTilt = 0;
                this.deviceRoll = 0;
                this.selectedSatellite = null;
                this.magneticDeclination = 0;
                this.gpsAccuracy = 0;
                this.calibrated = false;
                this.orientationPermission = false;
                this.cameraPermission = false;
                this.locationPermission = false;
            }

            async startInitialization() {
                try {
                    this.updateLoadingText('ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...');
                    await this.checkPermissions();
                    
                    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…ØªØ§Ø­Ø© (Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© ØºÙŠØ± iOS)
                    if (this.cameraPermission && this.locationPermission && this.orientationPermission) {
                        await this.continueSetup();
                    }
                    // ÙˆØ¥Ù„Ø§ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø·Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                    
                } catch (error) {
                    this.showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©', error.message);
                }
            }

            async continueSetup() {
                this.updateLoadingText('Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…ØºÙ†Ø§Ø·ÙŠØ³ÙŠ...');
                await this.calculateMagneticDeclination();
                
                this.updateLoadingText('ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...');
                await this.setupCamera();
                
                this.updateLoadingText('ØªÙ‡ÙŠØ¦Ø© Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø§Ø³ØªØ´Ø¹Ø§Ø±...');
                await this.setupSensors();
                
                this.updateLoadingText('ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...');
                this.setupEventListeners();
                
                this.updateLoadingText('Ù…ÙƒØªÙ…Ù„!');
                setTimeout(() => {
                    this.loadingScreen.style.display = 'none';
                    this.startUpdates();
                }, 500);
            }

            updateLoadingText(text) {
                this.loadingDetails.textContent = text;
            }

            async checkPermissions() {
                // Ù„Ù„Ø§ÙŠÙÙˆÙ† - Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø·Ù„Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                if (this.isIOS()) {
                    this.permissionButtons.style.display = 'block';
                    this.updateLoadingText('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
                    return;
                }

                // Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø®Ø±Ù‰ - Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
                try {
                    await this.requestAllPermissions();
                } catch (error) {
                    this.permissionButtons.style.display = 'block';
                    this.updateLoadingText('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                }
            }

            isIOS() {
                return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                       (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            }

            async requestAllPermissions() {
                // Ø·Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                await this.getUserMedia();
                this.cameraPermission = true;

                // Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹  
                await this.getUserLocation();
                this.locationPermission = true;

                // Ø·Ù„Ø¨ Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø§Ø³ØªØ´Ø¹Ø§Ø± (Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© ØºÙŠØ± iOS)
                this.orientationPermission = true;
            }

            async getUserLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Ø®Ø¯Ù…Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­Ø©'));
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            this.userLat = position.coords.latitude;
                            this.userLon = position.coords.longitude;
                            this.gpsAccuracy = Math.round(position.coords.accuracy);
                            document.getElementById('gpsAccuracy').textContent = this.gpsAccuracy + 'Ù…';
                            resolve();
                        },
                        (error) => {
                            let message = 'ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    message = 'ØªÙ… Ø±ÙØ¶ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    message = 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­';
                                    break;
                                case error.TIMEOUT:
                                    message = 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                                    break;
                            }
                            reject(new Error(message));
                        },
                        { 
                            enableHighAccuracy: true, 
                            timeout: 15000, 
                            maximumAge: 300000 
                        }
                    );
                });
            }

            async calculateMagneticDeclination() {
                // Ø­Ø³Ø§Ø¨ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…ØºÙ†Ø§Ø·ÙŠØ³ÙŠ
                const lat = this.userLat;
                const lon = this.userLon;
                
                // Ù…Ø¹Ø§Ø¯Ù„Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…ØºÙ†Ø§Ø·ÙŠØ³ÙŠ
                this.magneticDeclination = Math.sin(lat * Math.PI / 180) * Math.sin(lon * Math.PI / 180) * 15;
                this.magneticDeclination = Math.round(this.magneticDeclination * 10) / 10;
                
                document.getElementById('magneticDeclination').textContent = this.magneticDeclination + 'Â°';
            }

            async setupCamera() {
                if (!this.cameraPermission) {
                    throw new Error('Ù„Ù… ÙŠØªÙ… Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§');
                }

                return this.getUserMedia();
            }

            async getUserMedia() {
                try {
                    const constraints = {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1920, min: 1280 },
                            height: { ideal: 1080, min: 720 },
                            frameRate: { ideal: 30, min: 15 }
                        }
                    };

                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = stream;
                    
                    return new Promise((resolve) => {
                        this.video.onloadedmetadata = () => {
                            resolve();
                        };
                    });
                } catch (error) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + error.message);
                }
            }

            async setupSensors() {
                if (!this.orientationPermission) {
                    throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø§Ø³ØªØ´Ø¹Ø§Ø±');
                }

                window.addEventListener('deviceorientation', (event) => {
                    if (event.alpha !== null) {
                        // ØªØ·Ø¨ÙŠÙ‚ ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù Ø§Ù„Ù…ØºÙ†Ø§Ø·ÙŠØ³ÙŠ
                        this.deviceHeading = (event.alpha + this.magneticDeclination + 360) % 360;
                    }
                    if (event.beta !== null) {
                        this.deviceTilt = event.beta;
                    }
                    if (event.gamma !== null) {
                        this.deviceRoll = event.gamma;
                    }
                    
                    this.updateSensorDisplay();
                });

                // ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©
                this.startCalibration();
            }

            startCalibration() {
                let calibrationSamples = [];
                let sampleCount = 0;
                
                const calibrationInterval = setInterval(() => {
                    if (this.deviceHeading !== 0) {
                        calibrationSamples.push(this.deviceHeading);
                        sampleCount++;
                        
                        if (sampleCount >= 10) {
                            // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ù„Ù„Ù…Ø¹Ø§ÙŠØ±Ø©
                            const average = calibrationSamples.reduce((a, b) => a + b) / calibrationSamples.length;
                            this.calibrationOffset = average - this.deviceHeading;
                            this.calibrated = true;
                            clearInterval(calibrationInterval);
                        }
                    }
                }, 100);
            }

            updateSensorDisplay() {
                document.getElementById('deviceHeading').textContent = Math.round(this.deviceHeading) + 'Â°';
                document.getElementById('deviceTilt').textContent = Math.round(this.deviceTilt) + 'Â°';
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙˆØµÙ„Ø©
                const needle = document.getElementById('compassNeedle');
                needle.style.transform = `translateX(-50%) rotate(${this.deviceHeading}deg)`;
                
                const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
                const directionIndex = Math.round(this.deviceHeading / 45) % 8;
                document.getElementById('compassDirection').textContent = directions[directionIndex];
            }

            setupEventListeners() {
                this.satelliteSelect.addEventListener('change', () => {
                    this.selectedSatellite = this.satelliteSelect.value;
                    this.updateSatelliteInfo();
                });

                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØºÙŠÙŠØ± Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø´Ø§Ø´Ø©
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => {
                        this.updateDisplay();
                    }, 500);
                });

                // ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ…Ø± Ù„Ù„Ø´Ø§Ø´Ø©
                this.updateInterval = setInterval(() => {
                    this.updateDisplay();
                }, 100);
            }

            startUpdates() {
                // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©
                this.updateDisplay();
            }

            updateSatelliteInfo() {
                if (!this.selectedSatellite) {
                    this.satelliteInfo.classList.remove('visible');
                    return;
                }

                const satellite = this.satellites[this.selectedSatellite];
                document.getElementById('satName').textContent = satellite.name;
                document.getElementById('satDetails').innerHTML = `
                    <strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> ${satellite.longitude}Â°<br>
                    <strong>Ø§Ù„ÙˆØµÙ:</strong> ${satellite.description}<br>
                    <strong>Ø§Ù„ØªØºØ·ÙŠØ©:</strong> ${satellite.footprint}<br>
                    <strong>Ø§Ù„Ù‚Ø¯Ø±Ø©:</strong> ${satellite.power}<br>
                    <strong>ØªØ±Ø¯Ø¯Ø§Øª Ù…Ø®ØªØ§Ø±Ø©:</strong><br>
                    ${satellite.frequencies.slice(0, 3).join('<br>')}
                `;
                this.satelliteInfo.classList.add('visible');
            }

            calculatePreciseSatellitePosition(satLongitude) {
                if (!this.userLat || !this.userLon) return null;

                const userLatRad = this.userLat * Math.PI / 180;
                const userLonRad = this.userLon * Math.PI / 180;
                const satLonRad = satLongitude * Math.PI / 180;
                const deltaLon = satLonRad - userLonRad;

                // Ø­Ø³Ø§Ø¨Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¬ÙŠÙˆÙ„ÙˆØ¬ÙŠØ© Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©
                const earthRadius = 6371000; // Ù…ØªØ±
                const satAltitude = 35786000; // Ù…ØªØ±
                const satRadius = earthRadius + satAltitude;

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
                const cosUserLat = Math.cos(userLatRad);
                const sinUserLat = Math.sin(userLatRad);
                const cosDeltaLon = Math.cos(deltaLon);
                const sinDeltaLon = Math.sin(deltaLon);

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ (Azimuth) Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©
                const azimuthRad = Math.atan2(
                    sinDeltaLon,
                    cosUserLat * Math.tan(0) - sinUserLat * cosDeltaLon
                );
                let azimuth = (azimuthRad * 180 / Math.PI + 360) % 360;

                // ØªØµØ­ÙŠØ­ Ù„Ù„Ù†ØµÙ Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠ
                if (this.userLat < 0) {
                    azimuth = (180 - azimuth + 360) % 360;
                }

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (Elevation) Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©
                const groundDistance = earthRadius * Math.acos(
                    sinUserLat * Math.sin(0) + cosUserLat * Math.cos(0) * cosDeltaLon
                );
                
                const slantRange = Math.sqrt(
                    Math.pow(satRadius, 2) + Math.pow(earthRadius, 2) - 
                    2 * satRadius * earthRadius * Math.cos(groundDistance / earthRadius)
                );

                const elevationRad = Math.asin(
                    (satRadius * Math.sin(groundDistance / earthRadius)) / slantRange
                ) - (groundDistance / earthRadius);
                
                const elevation = Math.max(0, elevationRad * 180 / Math.PI);

                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ù†Ø­Ø±Ø§Ù (Skew/Polarization) Ù„Ù„Ù€ LNB
                const skewRad = Math.atan2(
                    sinDeltaLon * sinUserLat,
                    Math.cos(0) * cosUserLat - Math.sin(0) * sinUserLat * cosDeltaLon
                );
                const skew = skewRad * 180 / Math.PI;

                return {
                    azimuth: Math.round(azimuth * 10) / 10,
                    elevation: Math.round(elevation * 10) / 10,
                    skew: Math.round(skew * 10) / 10,
                    distance: Math.round(slantRange / 1000), // ÙƒÙ…
                    valid: elevation > 0
                };
            }

            updateDisplay() {
                if (!this.selectedSatellite || !this.userLat) {
                    this.updateAlignmentStatus('Ø§Ø®ØªØ± Ù‚Ù…Ø± ØµÙ†Ø§Ø¹ÙŠ', 'Ù‚Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± Ù‚Ù…Ø± ØµÙ†Ø§Ø¹ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¹Ù„Ø§Ù‡', 0);
                    return;
                }

                const satellite = this.satellites[this.selectedSatellite];
                const position = this.calculatePreciseSatellitePosition(satellite.longitude);

                if (!position || !position.valid) {
                    this.updateAlignmentStatus('Ø§Ù„Ù‚Ù…Ø± ØºÙŠØ± Ù…Ø±Ø¦ÙŠ', 'Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ ØªØ­Øª Ø§Ù„Ø£ÙÙ‚ Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ', 0);
                    return;
                }

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
                document.getElementById('azimuth').textContent = position.azimuth + 'Â°';
                document.getElementById('elevation').textContent = position.elevation + 'Â°';
                document.getElementById('skew').textContent = position.skew + 'Â°';

                // Ø­Ø³Ø§Ø¨ Ø¯Ù‚Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
                const angleDiff = this.calculateAngleDifference(this.deviceHeading, position.azimuth);
                const tiltDiff = Math.abs(this.deviceTilt - position.elevation);
                
                const azimuthAccuracy = Math.max(0, 100 - (angleDiff * 2));
                const elevationAccuracy = Math.max(0, 100 - (tiltDiff * 4));
                const overallAccuracy = (azimuthAccuracy + elevationAccuracy) / 2;

                this.updateAlignmentStatus(
                    this.getAlignmentStatusText(overallAccuracy),
                    this.getAlignmentDetails(angleDiff, tiltDiff, position),
                    overallAccuracy
                );

                // Ø±Ø³Ù… Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ
                this.drawSatelliteMarker(position, angleDiff, elevationAccuracy);

                // ØªØ­Ø¯ÙŠØ« Ø®Ø· Ø§Ù„Ø£ÙÙ‚
                this.updateHorizonLine();
            }

            calculateAngleDifference(angle1, angle2) {
                let diff = Math.abs(angle1 - angle2);
                return Math.min(diff, 360 - diff);
            }

            getAlignmentStatusText(accuracy) {
                if (accuracy >= 95) return 'ğŸ¯ Ù…ÙˆØ¬Ù‡ Ø¨Ø¯Ù‚Ø© Ù…Ø«Ø§Ù„ÙŠØ©!';
                if (accuracy >= 85) return 'âœ… ØªÙˆØ¬ÙŠÙ‡ Ù…Ù…ØªØ§Ø²';
                if (accuracy >= 70) return 'ğŸŸ¡ ØªÙˆØ¬ÙŠÙ‡ Ø¬ÙŠØ¯';
                if (accuracy >= 50) return 'ğŸŸ  ØªÙˆØ¬ÙŠÙ‡ Ù…ØªÙˆØ³Ø·';
                if (accuracy >= 30) return 'ğŸ”´ ÙŠØ­ØªØ§Ø¬ ØªØ¹Ø¯ÙŠÙ„';
                return 'âŒ ØºÙŠØ± Ù…ÙˆØ¬Ù‡';
            }

            getAlignmentDetails(angleDiff, tiltDiff, position) {
                let details = [];
                
                if (angleDiff > 5) {
                    const direction = this.deviceHeading < position.azimuth ? 'ÙŠÙ…ÙŠÙ†Ø§Ù‹' : 'ÙŠØ³Ø§Ø±Ø§Ù‹';
                    details.push(`Ø§Ø³ØªØ¯Ø± ${Math.round(angleDiff)}Â° ${direction}`);
                }
                
                if (tiltDiff > 3) {
                    const direction = this.deviceTilt < position.elevation ? 'Ù„Ù„Ø£Ø¹Ù„Ù‰' : 'Ù„Ù„Ø£Ø³ÙÙ„';
                    details.push(`Ø§ØªØ¬Ù‡ ${Math.round(tiltDiff)}Â° ${direction}`);
                }
                
                if (details.length === 0) {
                    details.push('Ø§Ù„Ø·Ø¨Ù‚ Ù…ÙˆØ¬Ù‡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ù†Ø­Ùˆ Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ');
                }
                
                details.push(`Ø§Ù„Ù…Ø³Ø§ÙØ©: ${position.distance} ÙƒÙ…`);
                
                return details.join(' â€¢ ');
            }

            updateAlignmentStatus(status, details, accuracy) {
                document.getElementById('alignmentStatus').textContent = status;
                document.getElementById('alignmentDetails').textContent = details;
                
                const signalBar = document.getElementById('signalBar');
                const signalText = document.getElementById('signalText');
                
                signalBar.style.width = accuracy + '%';
                signalText.textContent = `Ø¯Ù‚Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡: ${Math.round(accuracy)}%`;
            }

            drawSatelliteMarker(position, angleDiff, elevationAccuracy) {
                this.markersContainer.innerHTML = '';

                if (angleDiff < 60 && elevationAccuracy > 20) {
                    const marker = document.createElement('div');
                    marker.className = 'satellite-marker';

                    const markerCircle = document.createElement('div');
                    markerCircle.className = 'marker-circle';
                    markerCircle.textContent = 'ğŸ›°ï¸';

                    // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¯Ù‚Ø©
                    if (angleDiff < 3 && elevationAccuracy > 90) {
                        markerCircle.classList.add('aligned');
                    } else if (angleDiff < 10 && elevationAccuracy > 70) {
                        markerCircle.classList.add('close');
                    }

                    marker.appendChild(markerCircle);

                    // Ø­Ø³Ø§Ø¨ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
                    const screenWidth = window.innerWidth;
                    const screenHeight = window.innerHeight;

                    const relativeAzimuth = position.azimuth - this.deviceHeading;
                    const relativeElevation = position.elevation - this.deviceTilt;

                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø²ÙˆØ§ÙŠØ§ Ø§Ù„Ù†Ø³Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø´Ø§Ø´Ø©
                    const x = screenWidth / 2 + (relativeAzimuth * screenWidth / 60);
                    const y = screenHeight / 2 - (relativeElevation * screenHeight / 60);

                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¶Ù…Ù† Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ø§Ø´Ø©
                    const clampedX = Math.max(50, Math.min(screenWidth - 50, x));
                    const clampedY = Math.max(100, Math.min(screenHeight - 100, y));

                    marker.style.left = clampedX + 'px';
                    marker.style.top = clampedY + 'px';

                    this.markersContainer.appendChild(marker);
                }
            }

            updateHorizonLine() {
                const horizonLine = document.getElementById('horizonLine');
                const screenHeight = window.innerHeight;
                
                // Ø­Ø³Ø§Ø¨ Ù…ÙˆÙ‚Ø¹ Ø®Ø· Ø§Ù„Ø£ÙÙ‚ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ù…Ø§Ù„Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²
                const horizonY = screenHeight / 2 + (this.deviceTilt * screenHeight / 90);
                
                horizonLine.style.top = Math.max(0, Math.min(screenHeight, horizonY)) + 'px';
                horizonLine.style.opacity = Math.abs(this.deviceTilt) > 5 ? '0.5' : '0.2';
            }

            showError(title, message) {
                const errorDialog = document.createElement('div');
                errorDialog.className = 'error-dialog';
                errorDialog.innerHTML = `
                    <div class="error-icon">âš ï¸</div>
                    <div class="error-title">${title}</div>
                    <div class="error-message">${message}</div>
                `;
                document.body.appendChild(errorDialog);

                setTimeout(() => {
                    if (errorDialog.parentNode) {
                        errorDialog.parentNode.removeChild(errorDialog);
                    }
                }, 5000);
            }
        }

        // ØªØ³Ø¬ÙŠÙ„ Service Worker Ù„Ù„Ø¹Ù…Ù„ Offline
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', () => {
            satApp = new ProfessionalSatelliteFinder();
        });

        // Ù…Ù†Ø¹ Ø§Ù„Ù†ÙˆÙ… ÙˆØ¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ø¶ÙŠØ¦Ø©
        let wakeLock = null;
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').then((lock) => {
                wakeLock = lock;
            }).catch(err => {
                console.log('Wake lock failed:', err);
            });
        }

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        window.addEventListener('beforeunload', () => {
            if (wakeLock) {
                wakeLock.release();
            }
        });
    </script>
</body>
</html>
